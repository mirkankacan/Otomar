@{
    ViewData["Title"] = "Hesabım";
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["BreadcrumbItems"] = new List<BreadcrumbItem>
{
new("Ana Sayfa", "/ana-sayfa"),
new(ViewData["Title"] as string ?? "Hesabım", null),
};
}
@section Styles {
    <style>
        .order-detail-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: #fff;
            border: none;
        }

        .order-detail-btn:hover {
            background-color: black;
            color: #fff;
            border: none;
        }

        .fa-book {
            font-size: 15px;
        }

        /* Sipariş detay modal */
        #orderDetailModal .modal-dialog {
            max-width: 720px;
        }

        #orderDetailModal .modal-header {
            background: var(--bg-offwhite-color, #f8f9fa);
            padding: 1rem 1.25rem;
        }

        #orderDetailModal .modal-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        #orderDetailModal .modal-body {
            padding: 1.25rem;
            max-height: 75vh;
            overflow-y: auto;
        }

        .order-detail-section {
            margin-bottom: 1.25rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid #e9ecef;
        }

        .order-detail-section:last-of-type {
            border-bottom: 0;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .order-detail-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #6c757d;
            margin-bottom: 0.75rem;
        }

        .order-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem 1.25rem;
        }

        .order-detail-field {
            font-size: 0.9375rem;
        }

        .order-detail-field label {
            display: block;
            color: #6c757d;
            font-size: 0.75rem;
            margin-bottom: 0.15rem;
        }

        .order-detail-field span {
            font-weight: 500;
            color: #212529;
        }

        .order-detail-items-table {
            width: 100%;
            font-size: 0.875rem;
            border-collapse: collapse;
        }

        .order-detail-items-table th,
        .order-detail-items-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .order-detail-items-table th {
            font-weight: 600;
            color: #6c757d;
            background: #f8f9fa;
        }

        .order-detail-items-table .text-end {
            text-align: right;
        }

        .order-detail-items-table .text-center {
            text-align: center;
        }

        .order-detail-address-block {
            font-size: 0.875rem;
            line-height: 1.5;
            color: #495057;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .order-detail-totals {
            font-size: 0.9375rem;
        }

        .order-detail-totals .row-total {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
        }

        .order-detail-totals .row-total.final {
            font-weight: 600;
            font-size: 1rem;
            padding-top: 0.5rem;
            margin-top: 0.25rem;
            border-top: 1px solid #dee2e6;
        }

        .order-detail-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .order-detail-badge.sanal-pos {
            background: #e7f1ff;
            color: #0d6efd;
        }

        .order-detail-badge.siparis {
            background: #d1e7dd;
            color: #0f5132;
        }
    </style>
}
<!-- my account section start -->
<section class="my__account--section section--padding">
    <div class="container">
        <div class="my__account--section__inner border-radius-10 d-flex">
            <div class="account__left--sidebar">
                <h2 class="account__content--title mb-20">Hesabım</h2>
                <ul class="account__menu">
                    <li class="account__menu--list active"><a href="/hesabim">Sipariş Geçmişi</a></li>
                    <li class="account__menu--list"><a href="/liste-sorgu">Liste Sorgular</a></li>
                    <li class="account__menu--list"><a href="/cari/hesap-hareketleri">Cari Hesap Hareketleri</a></li>
                    <li class="account__menu--list"><a href="/profilim">Kullanıcı Bilgileri</a></li>
                    <li class="account__menu--list"><a href="/cikis-yap">Çıkış Yap</a></li>
                </ul>
            </div>
            <div class="account__wrapper">
                <div class="account__content">
                    <h2 class="account__content--title h3 mb-20">Sipariş Geçmişi</h2>
                    <div class="account__table--area">
                        <div id="orders-loading" class="text-center py-5 text-secondary">Siparişler yükleniyor...</div>
                        <div id="orders-empty" class="text-center py-5 text-secondary" style="display: none;">Henüz
                            siparişiniz bulunmuyor.</div>
                        <table class="account__table" id="orders-table" style="display: none;">
                            <thead class="account__table--header">
                                <tr class="account__table--header__child">
                                    <th class="account__table--header__child--items">SipNo</th>
                                    <th class="account__table--header__child--items">Tür</th>
                                    <th class="account__table--header__child--items">Tarih</th>
                                    <th class="account__table--header__child--items" style="text-align:center">Detaylar
                                    </th>
                                    <th class="account__table--header__child--items">Tutar</th>
                                </tr>
                            </thead>
                            <tbody class="account__table--body mobile__none" id="orders-tbody"></tbody>
                            <tbody class="account__table--body mobile__block" id="orders-tbody-mobile"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- my account section end -->

<!-- Sipariş detay modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-radius-10">
            <div class="modal-header border-bottom">
                <h5 class="modal-title" id="orderDetailModalLabel">Sipariş Detayı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body" id="orderDetailModalBody">
                <div id="order-detail-loading" class="text-center py-5">Yükleniyor...</div>
                <div id="order-detail-content" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            loadMyOrders();
        });

        function formatDate(dateStr) {
            if (!dateStr) return '—';
            var d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            var day = ('0' + d.getDate()).slice(-2);
            var month = ('0' + (d.getMonth() + 1)).slice(-2);
            var year = d.getFullYear();
            var hours = ('0' + d.getHours()).slice(-2);
            var minutes = ('0' + d.getMinutes()).slice(-2);
            return day + '.' + month + '.' + year + ' ' + hours + ':' + minutes;
        }

        function loadMyOrders() {
            makeRequest('/siparis/siparislerim', 'GET')
                .then(function (orders) {
                    $('#orders-loading').hide();
                    if (!orders || !Array.isArray(orders) || orders.length === 0) {
                        $('#orders-empty').show();
                        return;
                    }
                    $('#orders-table').show();
                    $('#orders-tbody').empty();
                    $('#orders-tbody-mobile').empty();
                    $.each(orders, function (i, order) {
                        var code = order.code || order.Code || '—';
                        var orderType = order.orderType != null ? order.orderType : order.OrderType;
                        var turLabel = orderType === 0 ? 'Sanal POS' : (orderType === 1 ? 'Sipariş' : '—');
                        var date = formatDate(order.createdAt || order.CreatedAt);
                        var total = formatTurkishLira(order.totalAmount != null ? order.totalAmount : order.TotalAmount);
                        var id = order.id || order.Id;
                        var btn = '<button type="button" class="btn btn-sm order-detail-btn" data-order-id="' + id + '"><i class="fa-solid fa-book"></i></button>';
                        $('#orders-tbody').append(
                            '<tr class="account__table--body__child">' +
                            '<td class="account__table--body__child--items">#' + (code || id) + '</td>' +
                            '<td class="account__table--body__child--items">' + turLabel + '</td>' +
                            '<td class="account__table--body__child--items">' + date + '</td>' +
                            '<td class="account__table--body__child--items" style="text-align:center">' + btn + '</td>' +
                            '<td class="account__table--body__child--items">' + total + '</td></tr>'
                        );
                        $('#orders-tbody-mobile').append(
                            '<tr class="account__table--body__child">' +
                            '<td class="account__table--body__child--items"><strong>SipNo</strong><span>#' + (code || id) + '</span></td>' +
                            '<td class="account__table--body__child--items"><strong>Tür</strong><span>' + turLabel + '</span></td>' +
                            '<td class="account__table--body__child--items"><strong>Tarih</strong><span>' + date + '</span></td>' +
                            '<td class="account__table--body__child--items"><strong>Detaylar</strong><span>' + btn + '</span></td>' +
                            '<td class="account__table--body__child--items"><strong>Toplam</strong><span>' + total + '</span></td></tr>'
                        );
                    });
                    $(document).off('click', '.order-detail-btn').on('click', '.order-detail-btn', function () {
                        var orderId = $(this).data('order-id');
                        openOrderDetailModal(orderId);
                    });
                })
                .catch(function () {
                    $('#orders-loading').hide();
                    $('#orders-empty').text('Siparişler yüklenirken bir hata oluştu.').show();
                });
        }

        function openOrderDetailModal(orderId) {
            var $modal = $('#orderDetailModal');
            var $loading = $('#order-detail-loading');
            var $content = $('#order-detail-content');
            $('#orderDetailModalLabel').text('Sipariş Detayı');
            $content.hide().empty();
            $loading.show();
            $modal.modal('show');

            makeRequest('/siparis/' + orderId, 'GET')
                .then(function (order) {
                    $loading.hide();
                    var code = order.code || order.Code || orderId;
                    var orderType = order.orderType != null ? order.orderType : order.OrderType;
                    var typeLabel = orderType === 0 ? 'Sanal POS' : (orderType === 1 ? 'Sipariş' : 'Detay');
                    $('#orderDetailModalLabel').text('Sipariş #' + code + ' — ' + typeLabel);
                    $content.html(buildOrderDetailHtml(order)).show();
                })
                .catch(function () {
                    $loading.hide();
                    $content.html('<p class="text-danger">Sipariş detayı yüklenemedi.</p>').show();
                });
        }

        function getOrderTypeLabel(orderType) {
            var t = orderType != null ? orderType : -1;
            return t === 0 ? 'Sanal POS' : (t === 1 ? 'Sipariş' : '—');
        }

        function buildOrderDetailHtml(order) {
            var code = order.code || order.Code || '—';
            var orderType = order.orderType != null ? order.orderType : order.OrderType;
            var typeLabel = getOrderTypeLabel(orderType);
            var typeClass = orderType === 0 ? 'sanal-pos' : 'siparis';
            var createdAt = formatDate(order.createdAt || order.CreatedAt);
            var total = formatTurkishLira(order.totalAmount != null ? order.totalAmount : order.TotalAmount);
            var subTotal = formatTurkishLira(order.subTotalAmount != null ? order.subTotalAmount : order.SubTotalAmount);
            var shipping = formatTurkishLira(order.shippingAmount != null ? order.shippingAmount : order.ShippingAmount);
            var email = order.email || order.Email || '';
            var identityNumber = order.identityNumber || order.IdentityNumber || '';

            var html = '';

            // Genel bilgiler
            html += '<div class="order-detail-section">';
            html += '<div class="order-detail-section-title">Genel Bilgiler</div>';
            html += '<div class="order-detail-grid">';
            html += '<div class="order-detail-field"><label>Sipariş No</label><span>#' + code + '</span></div>';
            html += '<div class="order-detail-field"><label>Tür</label><span><span class="order-detail-badge ' + typeClass + '">' + typeLabel + '</span></span></div>';
            html += '<div class="order-detail-field"><label>Tarih</label><span>' + createdAt + '</span></div>';
            html += '<div class="order-detail-field"><label>E-posta</label><span>' + (email || '—') + '</span></div>';
            html += '<div class="order-detail-field"><label>TC / Vergi No</label><span>' + (identityNumber || '—') + '</span></div>';
            html += '</div></div>';

            // Ürünler (Items)
            var items = order.items || order.Items || [];
            if (items.length > 0) {
                html += '<div class="order-detail-section">';
                html += '<div class="order-detail-section-title">Ürünler</div>';
                html += '<div class="table-responsive"><table class="order-detail-items-table">';
                html += '<thead><tr><th>Ürün</th><th>Stok Kodu</th><th class="text-end">Birim Fiyat</th><th class="text-center">Adet</th><th class="text-end">Tutar</th></tr></thead><tbody>';
                $.each(items, function (i, item) {
                    var name = (item.productName || item.ProductName || '—').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    var pcode = (item.productCode || item.ProductCode || '—').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    var unitPrice = item.unitPrice != null ? item.unitPrice : item.UnitPrice;
                    var qty = item.quantity != null ? item.quantity : item.Quantity;
                    var lineTotal = (unitPrice || 0) * (qty || 0);
                    html += '<tr><td>' + name + '</td><td>' + pcode + '</td><td class="text-end">' + formatTurkishLira(unitPrice) + '</td><td class="text-center">' + qty + '</td><td class="text-end">' + formatTurkishLira(lineTotal) + '</td></tr>';
                });
                html += '</tbody></table></div></div>';
            }

            // Adresler
            var billing = order.billingAddress || order.BillingAddress;
            var shippingAddr = order.shippingAddress || order.ShippingAddress;
            if (billing && (billing.name || billing.Name || billing.street || billing.Street || billing.city || billing.City || billing.phone || billing.Phone)) {
                html += '<div class="order-detail-section">';
                html += '<div class="order-detail-section-title">Fatura Adresi</div>';
                html += '<div class="order-detail-address-block">';
                html += (billing.name || billing.Name || '') + '<br>';
                if (billing.street || billing.Street) html += (billing.street || billing.Street) + '<br>';
                if (billing.district || billing.District || billing.city || billing.City) html += (billing.district || billing.District || '') + ' ' + (billing.city || billing.City || '') + '<br>';
                if (billing.phone || billing.Phone) html += (billing.phone || billing.Phone || '');
                html += '</div></div>';
            }
            if (shippingAddr && (shippingAddr.name || shippingAddr.Name || shippingAddr.street || shippingAddr.Street || shippingAddr.city || shippingAddr.City || shippingAddr.phone || shippingAddr.Phone)) {
                html += '<div class="order-detail-section">';
                html += '<div class="order-detail-section-title">Teslimat Adresi</div>';
                html += '<div class="order-detail-address-block">';
                html += (shippingAddr.name || shippingAddr.Name || '') + '<br>';
                if (shippingAddr.street || shippingAddr.Street) html += (shippingAddr.street || shippingAddr.Street) + '<br>';
                if (shippingAddr.district || shippingAddr.District || shippingAddr.city || shippingAddr.City) html += (shippingAddr.district || shippingAddr.District || '') + ' ' + (shippingAddr.city || shippingAddr.City || '') + '<br>';
                if (shippingAddr.phone || shippingAddr.Phone) html += (shippingAddr.phone || shippingAddr.Phone || '');
                html += '</div></div>';
            }

            // Kurumsal
            var corp = order.corporate || order.Corporate;
            if (corp && (corp.companyName || corp.CompanyName || corp.taxNumber || corp.TaxNumber || corp.taxOffice || corp.TaxOffice)) {
                var cName = corp.companyName || corp.CompanyName || '';
                var taxNo = corp.taxNumber || corp.TaxNumber || '';
                var taxOff = corp.taxOffice || corp.TaxOffice || '';
                html += '<div class="order-detail-section">';
                html += '<div class="order-detail-section-title">Kurumsal Bilgi</div>';
                html += '<div class="order-detail-address-block">' + cName;
                if (taxNo) html += '<br>Vergi No: ' + taxNo;
                if (taxOff) html += (taxNo ? ' / ' : '<br>') + 'Vergi Dairesi: ' + taxOff;
                html += '</div></div>';
            }

            // Ödeme
            var payment = order.payment || order.Payment;
            if (payment && (payment.maskedCreditCard || payment.MaskedCreditCard || payment.bankCardBrand || payment.BankCardBrand || payment.bankCardIssuer || payment.BankCardIssuer)) {
                var mask = payment.maskedCreditCard || payment.MaskedCreditCard || '';
                var brand = payment.bankCardBrand || payment.BankCardBrand || '';
                var issuer = payment.bankCardIssuer || payment.BankCardIssuer || '';
                html += '<div class="order-detail-section">';
                html += '<div class="order-detail-section-title">Ödeme</div>';
                html += '<div class="order-detail-address-block">';
                if (mask) html += 'Kart: ' + mask + '<br>';
                if (brand) html += 'Marka: ' + brand + (issuer ? '<br>Banka: ' + issuer : '');
                else if (issuer) html += 'Banka: ' + issuer;
                html += '</div></div>';
            }

            // Toplamlar
            html += '<div class="order-detail-section">';
            html += '<div class="order-detail-section-title">Toplamlar</div>';
            html += '<div class="order-detail-totals">';
            html += '<div class="row-total"><span>Ara Toplam</span><span>' + subTotal + '</span></div>';
            if (order.shippingAmount != null && order.shippingAmount > 0 || (order.ShippingAmount != null && order.ShippingAmount > 0)) {
                html += '<div class="row-total"><span>Kargo</span><span>' + shipping + '</span></div>';
            }
            html += '<div class="row-total final"><span>Genel Toplam</span><span>' + total + '</span></div>';
            html += '</div></div>';

            return html;
        }
    </script>
}
