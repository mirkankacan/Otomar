@{
    ViewData["Title"] = "Mağaza";
    Layout = "/Views/Shared/_Layout.cshtml";
    var mainCategoryName = ViewBag.MainCategoryName as string;
    var subCategoryName = ViewBag.SubCategoryName as string;
    var brandName = ViewBag.BrandName as string;
    var modelName = ViewBag.ModelName as string;
    var versionName = ViewBag.VersionName as string;
    var manufacturerName = ViewBag.ManufacturerName as string;
    var minPrice = ViewBag.MinPrice as string;
    var maxPrice = ViewBag.MaxPrice as string;

       ViewData["BreadcrumbItems"] = new List<BreadcrumbItem>
    {
        new("Ana Sayfa", "/ana-sayfa"),
        new("Mağaza", "/magaza")
    };
}

<!-- Start shop section -->
<div class="shop__section">
    <div class="container">
        <div class="row">
            <div class="col-xl-3 col-lg-4 shop-col-width-lg-4" style="position: relative;">
                <div class="shop__sidebar--widget widget__area d-none d-lg-block"
                    style="position: sticky; top: 20px; align-self: flex-start; max-height: calc(100vh - 40px); overflow-y: auto;">
                    <div class="single__widget widget__bg">
                        <h2 class="widget__title h3 d-flex align-items-center justify-content-between w-100"
                            style="cursor: pointer;" id="categories-toggle">
                            <span>Kategoriler</span>
                            <svg id="categories-arrow" class="widget__categories--menu__arrowdown--icon"
                                style="top: unset !important; transition: transform 0.3s ease; transform: rotate(180deg);"
                                xmlns="http://www.w3.org/2000/svg" width="12.355" height="8.394">
                                <path d="M15.138,8.59l-3.961,3.952L7.217,8.59,6,9.807l5.178,5.178,5.178-5.178Z"
                                    transform="translate(-6 -8.59)" fill="currentColor"></path>
                            </svg>

                        </h2>
                        <ul id="shop-categories-menu" class="widget__categories--menu">
                            <!-- Kategoriler dinamik olarak yüklenecek -->
                        </ul>
                    </div>

                    <div class="single__widget widget__bg">
                        <h2 class="widget__title h3 d-flex align-items-center justify-content-between w-100"
                            style="cursor: pointer;" id="brands-toggle">
                            <span>Marka / Model / Versiyon</span>
                            <svg id="brands-arrow" class="widget__categories--menu__arrowdown--icon"
                                style="top: unset !important; transition: transform 0.3s ease; transform: rotate(180deg);"
                                xmlns="http://www.w3.org/2000/svg" width="12.355" height="8.394">
                                <path d="M15.138,8.59l-3.961,3.952L7.217,8.59,6,9.807l5.178,5.178,5.178-5.178Z"
                                    transform="translate(-6 -8.59)" fill="currentColor"></path>
                            </svg>
                        </h2>
                        <ul id="shop-brands-menu" class="widget__categories--menu">
                            <!-- Markalar dinamik olarak yüklenecek -->
                        </ul>
                    </div>
                    <div class="single__widget widget__bg">
                        <h2 class="widget__title h3">Üretici Marka</h2>
                        <ul id="shop-manufacturers-menu" class="widget__form--check">
                            <!-- Üreticiler dinamik olarak yüklenecek -->

                        </ul>
                    </div>
                    <div class="single__widget price__filter widget__bg">
                        <h2 class="widget__title h3">Fiyata Göre Filtrele</h2>
                            <div class="price__filter--form__inner mb-15 d-flex align-items-center">
                                <div class="price__filter--group">
                                    <label class="price__filter--label" for="Filter-Price-GTE2">En Az</label>
                                    <div class="price__filter--input border-radius-5 d-flex align-items-center">
                                        <span class="price__filter--currency">₺</span>
                                        <input class="price__filter--input__field border-0" name="filter.v.price.gte"
                                            id="Filter-Price-GTE2" type="number" placeholder="0" min="0" max="250.00">
                                    </div>
                                </div>
                                <div class="price__divider">
                                    <span>-</span>
                                </div>
                                <div class="price__filter--group">
                                    <label class="price__filter--label" for="Filter-Price-LTE2">En Çok</label>
                                    <div class="price__filter--input border-radius-5 d-flex align-items-center">
                                        <span class="price__filter--currency">₺</span>
                                        <input class="price__filter--input__field border-0" name="filter.v.price.lte"
                                            id="Filter-Price-LTE2" type="number" min="0" placeholder="250,00"
                                            max="250.00">
                                    </div>
                                </div>
                            </div>
                            <button class="primary__btn price__filter--btn" type="button">Filtrele</button>
                    </div>
                </div>
            </div>
            <div class="col-xl-9 col-lg-8 shop-col-width-lg-8">
                <div class="shop__right--sidebar">

                    <!-- Aktif Filtreler -->
                    <div id="active-filters-container" class="mb-20" style="display: none; background: var(--bg-offwhite-color); padding: 12px 16px; border-radius: 8px;">
                        <div class="d-flex align-items-center flex-wrap gap-2">
                            <span style="font-weight: 600; color: #333; font-size: 13px; margin-right: 8px;">Aktif Filtreler:</span>
                            <div id="active-filters-badges" class="d-flex align-items-center flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <!-- Arama -->
                    <div class="mb-20" style="background: var(--bg-offwhite-color); padding: 12px 16px; border-radius: 8px;">
                        <div class="d-flex header__search--form border-radius-5">
                            <div class="header__search--box" style="width:100%;">
                                <label>
                                    <input id="search-term-input"
                                           class="header__search--input"
                                           placeholder="Kelime ile filtrelemek için arama yapınız..."
                                           type="text">
                                </label>
                                <button id="search-btn"
                                        class="header__search--button bg__primary text-white"
                                        aria-label="search button"
                                        type="button">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M15.6952 14.4991L11.7663 10.5588C12.7765 9.4008 13.33 7.94381 13.33 6.42703C13.33 2.88322 10.34 0 6.66499 0C2.98997 0 0 2.88322 0 6.42703C0 9.97085 2.98997 12.8541 6.66499 12.8541C8.04464 12.8541 9.35938 12.4528 10.4834 11.6911L14.4422 15.6613C14.6076 15.827 14.8302 15.9184 15.0687 15.9184C15.2944 15.9184 15.5086 15.8354 15.6711 15.6845C16.0166 15.364 16.0276 14.8325 15.6952 14.4991ZM6.66499 1.67662C9.38141 1.67662 11.5913 3.8076 11.5913 6.42703C11.5913 9.04647 9.38141 11.1775 6.66499 11.1775C3.94857 11.1775 1.73869 9.04647 1.73869 6.42703C1.73869 3.8076 3.94857 1.67662 6.66499 1.67662Z" fill="currentColor" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="shop__product--wrapper">
                        <div class="shop__header d-flex align-items-center justify-content-between mb-30">
                            <div class="product__view--mode d-flex align-items-center">

                                <button class="widget__filter--btn d-flex d-lg-none align-items-center" data-offcanvas>
                                    <svg class="widget__filter--btn__icon" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 512 512">
                                        <path fill="none" stroke="currentColor" stroke-linecap="round"
                                            stroke-linejoin="round" stroke-width="28"
                                            d="M368 128h80M64 128h240M368 384h80M64 384h240M208 256h240M64 256h80" />
                                        <circle cx="336" cy="128" r="28" fill="none" stroke="currentColor"
                                            stroke-linecap="round" stroke-linejoin="round" stroke-width="28" />
                                        <circle cx="176" cy="256" r="28" fill="none" stroke="currentColor"
                                            stroke-linecap="round" stroke-linejoin="round" stroke-width="28" />
                                        <circle cx="336" cy="384" r="28" fill="none" stroke="currentColor"
                                            stroke-linecap="round" stroke-linejoin="round" stroke-width="28" />
                                    </svg>
                                    <span class="widget__filter--btn__text">Filtre</span>
                                </button>
                                <div class="product__view--mode__list product__short--by align-items-center d-flex ">
                                    <label class="product__view--label">Sayfa Başına :</label>
                                    <div class="select shop__header--select">
                                        <select id="pageSizeSelect" class="product__view--select">
                                            <option value="12">12</option>
                                            <option value="24">24</option>
                                            <option selected value="36">36</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="product__view--mode__list product__short--by align-items-center d-flex">
                                    <label class="product__view--label">Sırala :</label>
                                    <div class="select shop__header--select">
                                        <select id="orderBySelect" class="product__view--select">
                                            <option selected value="latest">En Yeniler</option>
                                            <option value="bestseller">En Çok Satan</option>
                                            <option value="cheap">Ucuzdan Pahalıya</option>
                                            <option value="expensive">Pahalıdan Ucuza</option>
                                        </select>
                                    </div>

                                </div>
                            </div>
                            <p class="product__showing--count">0 sonuçtan 0 gösteriliyor</p>
                        </div>
                        <div class="tab_content">
                            <div id="product_grid" class="tab_pane active show">
                                <div class="product__section--inner">
                                    <div id="shop-products-grid" class="row mb--n30">
                                        <!-- Ürünler dinamik olarak yüklenecek -->
                                    </div>
                                </div>
                                <!-- Infinite scroll loading indicator -->
                                <div id="infinite-scroll-loader" class="text-center py-4" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Yükleniyor...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Daha fazla ürün yükleniyor...</p>
                                </div>

                                <!-- Tüm ürünler yüklendi göstergesi -->
                                <div id="all-products-loaded" class="text-center py-4" style="display: none;">
                                    <!--  <p class="text-muted">Tüm ürünler yüklendi</p>-->
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- End shop section -->

@section Scripts {
    <script>
        // URL filtre parametreleri (ViewBag'den)
        const urlFilters = {
            mainCategory: '@(mainCategoryName ?? "")',
            subCategory: '@(subCategoryName ?? "")',
            brand: '@(brandName ?? "")',
            model: '@(modelName ?? "")',
            version: '@(versionName ?? "")',
            manufacturer: '@(manufacturerName ?? "")',
            minPrice: '@(minPrice ?? "")',
            maxPrice: '@(maxPrice ?? "")',
            searchTerm: @Html.Raw(Json.Serialize(ViewBag.SearchTerm ?? ""))
        };
        let currentPage = 1;
        let pageSize = 36;
        let orderBy = 'latest';
        let minPrice = urlFilters.minPrice ? parseFloat(urlFilters.minPrice) : null;
        let maxPrice = urlFilters.maxPrice ? parseFloat(urlFilters.maxPrice) : null;
        let isLoading = false;
        let hasMoreProducts = true;
        let totalProductCount = 0;

        // Mevcut filtreleri koruyarak yeni filtre URL'i oluştur
        function buildFilterUrl(newFilters) {
            let parts = [];

            // Kategori filtreleri
            const mainCategory = newFilters.mainCategory !== undefined ? newFilters.mainCategory : urlFilters.mainCategory;
            if (mainCategory) {
                parts.push(`kategori/${mainCategory}`);
                const subCategory = newFilters.subCategory !== undefined ? newFilters.subCategory :
                                   (newFilters.mainCategory !== undefined ? null : urlFilters.subCategory);
                if (subCategory) {
                    parts.push(subCategory);
                }
            }

            // Marka/Model/Versiyon filtreleri
            const brand = newFilters.brand !== undefined ? newFilters.brand : urlFilters.brand;
            if (brand) {
                parts.push(`marka/${brand}`);
                const model = newFilters.model !== undefined ? newFilters.model :
                             (newFilters.brand !== undefined ? null : urlFilters.model);
                if (model) {
                    parts.push(`model/${model}`);
                    const version = newFilters.version !== undefined ? newFilters.version :
                                   (newFilters.model !== undefined ? null : urlFilters.version);
                    if (version) {
                        parts.push(`versiyon/${version}`);
                    }
                }
            }

            // Üretici filtresi
            const manufacturer = newFilters.manufacturer !== undefined ? newFilters.manufacturer : urlFilters.manufacturer;
            if (manufacturer) {
                parts.push(`uretici/${manufacturer}`);
            }

            // Base URL
            let url = parts.length > 0 ? '/magaza/' + parts.join('/') : '/magaza';

            // Query parametreleri ekle
            const queryParams = [];
            const finalMinPrice = newFilters.minPrice !== undefined ? newFilters.minPrice : urlFilters.minPrice;
            const finalMaxPrice = newFilters.maxPrice !== undefined ? newFilters.maxPrice : urlFilters.maxPrice;
            const finalSearchTerm = newFilters.searchTerm !== undefined ? newFilters.searchTerm : urlFilters.searchTerm;

            if (finalMinPrice) {
                queryParams.push(`minPrice=${finalMinPrice}`);
            }
            if (finalMaxPrice) {
                queryParams.push(`maxPrice=${finalMaxPrice}`);
            }
            if (finalSearchTerm) {
                queryParams.push(`searchTerm=${encodeURIComponent(finalSearchTerm)}`);
            }

            if (queryParams.length > 0) {
                url += '?' + queryParams.join('&');
            }

            return url;
        }
                function updateBreadcrumbs() {
                    console.log("a")
            const breadcrumbList = document.getElementById('breadcrumb-list');
            if (!breadcrumbList) return;

            const categoriesMenu = document.getElementById('shop-categories-menu');
            const brandsMenu = document.getElementById('shop-brands-menu');
            const manufacturersMenu = document.getElementById('shop-manufacturers-menu');

            // Breadcrumb öğelerini oluştur
            const breadcrumbs = [
                { text: 'Ana Sayfa', url: '/ana-sayfa' },
                { text: 'Mağaza', url: '/magaza' }
            ];

            let position = 3;

            // Marka
            if (urlFilters.brand && brandsMenu) {
                const brandItem = Array.from(brandsMenu.querySelectorAll(':scope > li .widget__categories--menu__text'))
                    .find(span => generateSlug(span.textContent.trim()) === urlFilters.brand);
                if (brandItem) {
                    breadcrumbs.push({
                        text: brandItem.textContent.trim(),
                        url: `/magaza/marka/${urlFilters.brand}`
                    });
                }
            }

            // Model
            if (urlFilters.model && brandsMenu) {
                const modelItem = Array.from(brandsMenu.querySelectorAll('.widget__categories--sub__menu--text'))
                    .find(span => generateSlug(span.textContent.trim()) === urlFilters.model);
                if (modelItem) {
                    breadcrumbs.push({
                        text: modelItem.textContent.trim(),
                        url: `/magaza/marka/${urlFilters.brand}/model/${urlFilters.model}`
                    });
                }
            }

            // Versiyon
            if (urlFilters.version && brandsMenu) {
                const versionItem = Array.from(brandsMenu.querySelectorAll('ul.widget__categories--sub__menu[style*="border-left"] .widget__categories--sub__menu--text'))
                    .find(span => generateSlug(span.textContent.trim()) === urlFilters.version);
                if (versionItem) {
                    breadcrumbs.push({
                        text: versionItem.textContent.trim(),
                        url: `/magaza/marka/${urlFilters.brand}/model/${urlFilters.model}/versiyon/${urlFilters.version}`
                    });
                }
            }

            // Ana Kategori
            if (urlFilters.mainCategory && categoriesMenu) {
                const mainCategoryItem = Array.from(categoriesMenu.querySelectorAll('.widget__categories--menu__text'))
                    .find(span => generateSlug(span.textContent.trim()) === urlFilters.mainCategory);
                if (mainCategoryItem) {
                    breadcrumbs.push({
                        text: mainCategoryItem.textContent.trim(),
                        url: `/magaza/kategori/${urlFilters.mainCategory}`
                    });
                }
            }

            // Alt Kategori
            if (urlFilters.subCategory && categoriesMenu) {
                const subCategoryItem = Array.from(categoriesMenu.querySelectorAll('.widget__categories--sub__menu--text'))
                    .find(span => generateSlug(span.textContent.trim()) === urlFilters.subCategory);
                if (subCategoryItem) {
                    breadcrumbs.push({
                        text: subCategoryItem.textContent.trim(),
                        url: `/magaza/kategori/${urlFilters.mainCategory}/${urlFilters.subCategory}`
                    });
                }
            }

            // Breadcrumb HTML'ini oluştur
            breadcrumbList.innerHTML = '';
            breadcrumbs.forEach((breadcrumb, index) => {
                const li = document.createElement('li');
                li.className = 'breadcrumb__content--menu__items';
                li.setAttribute('itemprop', 'itemListElement');
                li.setAttribute('itemscope', '');
                li.setAttribute('itemtype', 'https://schema.org/ListItem');

                const isLast = index === breadcrumbs.length - 1;

                if (!isLast) {
                    const a = document.createElement('a');
                    a.href = breadcrumb.url;
                    a.setAttribute('itemprop', 'item');

                    const span = document.createElement('span');
                    span.setAttribute('itemprop', 'name');
                    span.textContent = breadcrumb.text;

                    a.appendChild(span);
                    li.appendChild(a);
                } else {
                    const span = document.createElement('span');
                    span.setAttribute('itemprop', 'name');
                    span.className = 'text-secondary';
                    span.textContent = breadcrumb.text;
                    li.appendChild(span);
                }

                const meta = document.createElement('meta');
                meta.setAttribute('itemprop', 'position');
                meta.content = (index + 1).toString();
                li.appendChild(meta);

                breadcrumbList.appendChild(li);
            });
        }
        // Aktif filtreleri gösterme fonksiyonu
        function renderActiveFilters() {
            const container = document.getElementById('active-filters-container');
            const badgesContainer = document.getElementById('active-filters-badges');

            if (!container || !badgesContainer) return;

            // Temizle
            badgesContainer.innerHTML = '';

            const activeFilters = [];

            // DOM'dan gerçek isimleri al
            const categoriesMenu = document.getElementById('shop-categories-menu');
            const brandsMenu = document.getElementById('shop-brands-menu');

            // Ana Kategori
            if (urlFilters.mainCategory && categoriesMenu) {
                const mainCategoryItem = Array.from(categoriesMenu.querySelectorAll('.widget__categories--menu__text'))
                    .find(span => generateSlug(span.textContent.trim()) === urlFilters.mainCategory);
                if (mainCategoryItem) {
                    activeFilters.push({
                        type: 'mainCategory',
                        value: urlFilters.mainCategory,
                        displayValue: mainCategoryItem.textContent.trim()
                    });
                }
            }

            // Alt Kategori
            if (urlFilters.subCategory && categoriesMenu) {
                const subCategoryItem = Array.from(categoriesMenu.querySelectorAll('.widget__categories--sub__menu--text'))
                    .find(span => generateSlug(span.textContent.trim()) === urlFilters.subCategory);
                if (subCategoryItem) {
                    activeFilters.push({
                        type: 'subCategory',
                        value: urlFilters.subCategory,
                        displayValue: subCategoryItem.textContent.trim()
                    });
                }
            }

            // Marka
            if (urlFilters.brand && brandsMenu) {
                const brandItem = Array.from(brandsMenu.querySelectorAll(':scope > li .widget__categories--menu__text'))
                    .find(span => generateSlug(span.textContent.trim()) === urlFilters.brand);
                if (brandItem) {
                    activeFilters.push({
                        type: 'brand',
                        value: urlFilters.brand,
                        displayValue: brandItem.textContent.trim()
                    });
                }
            }

            // Model
            if (urlFilters.model && brandsMenu) {
                const modelItem = Array.from(brandsMenu.querySelectorAll('.widget__categories--sub__menu--text'))
                    .find(span => {
                        const parent = span.closest('li.widget__categories--sub__menu--list');
                        return parent && !parent.querySelector('ul.widget__categories--sub__menu[style*="border-left"]') === false &&
                               generateSlug(span.textContent.trim()) === urlFilters.model;
                    });
                if (modelItem) {
                    activeFilters.push({
                        type: 'model',
                        value: urlFilters.model,
                        displayValue: modelItem.textContent.trim()
                    });
                }
            }

            // Versiyon
            if (urlFilters.version && brandsMenu) {
                const versionItem = Array.from(brandsMenu.querySelectorAll('ul.widget__categories--sub__menu[style*="border-left"] .widget__categories--sub__menu--text'))
                    .find(span => generateSlug(span.textContent.trim()) === urlFilters.version);
                if (versionItem) {
                    activeFilters.push({
                        type: 'version',
                        value: urlFilters.version,
                        displayValue: versionItem.textContent.trim()
                    });
                }
            }

            // Üretici
            if (urlFilters.manufacturer) {
                const manufacturersMenu = document.getElementById('shop-manufacturers-menu');
                if (manufacturersMenu) {
                    const manufacturerItem = Array.from(manufacturersMenu.querySelectorAll('.widget__categories--sub__menu--text'))
                        .find(span => generateSlug(span.textContent.trim()) === urlFilters.manufacturer);
                    if (manufacturerItem) {
                        activeFilters.push({
                            type: 'manufacturer',
                            value: urlFilters.manufacturer,
                            displayValue: manufacturerItem.textContent.trim()
                        });
                    }
                }
            }

            // Fiyat filtresi
            if (urlFilters.minPrice || urlFilters.maxPrice) {
                let priceDisplay = 'Fiyat: ';
                if (urlFilters.minPrice && urlFilters.maxPrice) {
                    priceDisplay += `₺${urlFilters.minPrice} - ₺${urlFilters.maxPrice}`;
                } else if (urlFilters.minPrice) {
                    priceDisplay += `₺${urlFilters.minPrice} ve üzeri`;
                } else if (urlFilters.maxPrice) {
                    priceDisplay += `₺${urlFilters.maxPrice} ve altı`;
                }

                activeFilters.push({
                    type: 'price',
                    value: 'price',
                    displayValue: priceDisplay
                });
            }

            // Arama terimi
            if (urlFilters.searchTerm) {
                activeFilters.push({
                    type: 'search',
                    value: 'search',
                    displayValue: `Arama: ${urlFilters.searchTerm}`
                });
            }

            // Eğer aktif filtre varsa göster
            if (activeFilters.length > 0) {
                container.style.display = 'block';

                activeFilters.forEach((filter, index) => {
                    const badge = document.createElement('div');
                    badge.style.cssText = `
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        padding: 4px 10px;
                        background-color: var(--secondary-color);
                        color: white;
                        border-radius: 16px;
                        font-size: 12px;
                        font-weight: 500;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    `;

                    const text = document.createElement('span');
                    text.textContent = filter.displayValue;
                    badge.appendChild(text);

                    // Çarpı ikonu
                    const closeIcon = document.createElement('span');
                    closeIcon.innerHTML = '×';
                    closeIcon.style.cssText = `
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        line-height: 1;
                        opacity: 0.8;
                        transition: opacity 0.2s;
                        color: white;
                    `;
                    closeIcon.onmouseover = () => {
                        closeIcon.style.opacity = '1';
                    };
                    closeIcon.onmouseout = () => {
                        closeIcon.style.opacity = '0.8';
                    };

                    // Filtreyi kaldırma fonksiyonu
                    closeIcon.onclick = function() {
                        let newUrl = '/magaza';
                        const parts = [];

                        // Kaldırılan filtreye göre yeni URL oluştur
                        switch(filter.type) {
                            case 'mainCategory':
                                // Ana kategori kaldırılırsa alt kategori de gider
                                // Marka/model/versiyon/üretici devam eder
                                if (urlFilters.brand) {
                                    parts.push(`marka/${urlFilters.brand}`);
                                    if (urlFilters.model) {
                                        parts.push(`model/${urlFilters.model}`);
                                        if (urlFilters.version) {
                                            parts.push(`versiyon/${urlFilters.version}`);
                                        }
                                    }
                                }
                                if (urlFilters.manufacturer) parts.push(`uretici/${urlFilters.manufacturer}`);
                                break;

                            case 'subCategory':
                                // Sadece alt kategori kaldırılır, ana kategori kalır
                                if (urlFilters.mainCategory) parts.push(`kategori/${urlFilters.mainCategory}`);
                                if (urlFilters.brand) {
                                    parts.push(`marka/${urlFilters.brand}`);
                                    if (urlFilters.model) {
                                        parts.push(`model/${urlFilters.model}`);
                                        if (urlFilters.version) parts.push(`versiyon/${urlFilters.version}`);
                                    }
                                }
                                if (urlFilters.manufacturer) parts.push(`uretici/${urlFilters.manufacturer}`);
                                break;

                            case 'brand':
                                // Marka kaldırılırsa model ve versiyon da gider
                                if (urlFilters.mainCategory) {
                                    parts.push(`kategori/${urlFilters.mainCategory}`);
                                    if (urlFilters.subCategory) parts.push(urlFilters.subCategory);
                                }
                                if (urlFilters.manufacturer) parts.push(`uretici/${urlFilters.manufacturer}`);
                                break;

                            case 'model':
                                // Model kaldırılırsa versiyon da gider, marka kalır
                                if (urlFilters.mainCategory) {
                                    parts.push(`kategori/${urlFilters.mainCategory}`);
                                    if (urlFilters.subCategory) parts.push(urlFilters.subCategory);
                                }
                                if (urlFilters.brand) parts.push(`marka/${urlFilters.brand}`);
                                if (urlFilters.manufacturer) parts.push(`uretici/${urlFilters.manufacturer}`);
                                break;

                            case 'version':
                                // Sadece versiyon kaldırılır, marka ve model kalır
                                if (urlFilters.mainCategory) {
                                    parts.push(`kategori/${urlFilters.mainCategory}`);
                                    if (urlFilters.subCategory) parts.push(urlFilters.subCategory);
                                }
                                if (urlFilters.brand) {
                                    parts.push(`marka/${urlFilters.brand}`);
                                    if (urlFilters.model) parts.push(`model/${urlFilters.model}`);
                                }
                                if (urlFilters.manufacturer) parts.push(`uretici/${urlFilters.manufacturer}`);
                                break;

                            case 'manufacturer':
                                // Sadece üretici kaldırılır
                                if (urlFilters.mainCategory) {
                                    parts.push(`kategori/${urlFilters.mainCategory}`);
                                    if (urlFilters.subCategory) parts.push(urlFilters.subCategory);
                                }
                                if (urlFilters.brand) {
                                    parts.push(`marka/${urlFilters.brand}`);
                                    if (urlFilters.model) {
                                        parts.push(`model/${urlFilters.model}`);
                                        if (urlFilters.version) parts.push(`versiyon/${urlFilters.version}`);
                                    }
                                }
                                break;

                            case 'price':
                                // Fiyat filtresi kaldırılır, diğer filtreler kalır
                                if (urlFilters.mainCategory) {
                                    parts.push(`kategori/${urlFilters.mainCategory}`);
                                    if (urlFilters.subCategory) parts.push(urlFilters.subCategory);
                                }
                                if (urlFilters.brand) {
                                    parts.push(`marka/${urlFilters.brand}`);
                                    if (urlFilters.model) {
                                        parts.push(`model/${urlFilters.model}`);
                                        if (urlFilters.version) parts.push(`versiyon/${urlFilters.version}`);
                                    }
                                }
                                if (urlFilters.manufacturer) parts.push(`uretici/${urlFilters.manufacturer}`);
                                break;

                            case 'search':
                                // Arama terimi kaldırılır, diğer filtreler kalır
                                if (urlFilters.mainCategory) {
                                    parts.push(`kategori/${urlFilters.mainCategory}`);
                                    if (urlFilters.subCategory) parts.push(urlFilters.subCategory);
                                }
                                if (urlFilters.brand) {
                                    parts.push(`marka/${urlFilters.brand}`);
                                    if (urlFilters.model) {
                                        parts.push(`model/${urlFilters.model}`);
                                        if (urlFilters.version) parts.push(`versiyon/${urlFilters.version}`);
                                    }
                                }
                                if (urlFilters.manufacturer) parts.push(`uretici/${urlFilters.manufacturer}`);
                                break;
                        }

                        // URL'i oluştur
                        if (parts.length > 0) {
                            newUrl += '/' + parts.join('/');
                        }

                        // Kaldırılan filtre hariç, diğer query parametreleri koru
                        const queryParams = [];
                        if (filter.type !== 'price') {
                            if (urlFilters.minPrice) queryParams.push(`minPrice=${urlFilters.minPrice}`);
                            if (urlFilters.maxPrice) queryParams.push(`maxPrice=${urlFilters.maxPrice}`);
                        }
                        if (filter.type !== 'search') {
                            if (urlFilters.searchTerm) queryParams.push(`searchTerm=${encodeURIComponent(urlFilters.searchTerm)}`);
                        }

                        if (queryParams.length > 0) {
                            newUrl += '?' + queryParams.join('&');
                        }

                        window.location.href = newUrl;
                    };

                    badge.appendChild(closeIcon);
                    badgesContainer.appendChild(badge);
                      updateBreadcrumbs();
                });
            } else {
                container.style.display = 'none';
            }
        }

        // Seçili filtreleri vurgulama fonksiyonu
        function highlightActiveFilters() {
            const categoriesMenu = document.getElementById('shop-categories-menu');
            const brandsMenu = document.getElementById('shop-brands-menu');

            // Kategoriler için vurgulama
            if (categoriesMenu) {
                const allMainCategoryItems = categoriesMenu.querySelectorAll(':scope > li.widget__categories--menu__list');

                // Önce tüm kategorileri göster ve stillerini sıfırla
                allMainCategoryItems.forEach(mainItem => {
                    mainItem.style.display = '';
                    const mainTextSpan = mainItem.querySelector('.widget__categories--menu__text');
                    if (mainTextSpan) {
                        mainTextSpan.style.color = '';
                        mainTextSpan.style.fontWeight = '';
                    }

                    // Alt kategori stillerini de sıfırla
                    const subMenu = mainItem.querySelector('.widget__categories--sub__menu');
                    if (subMenu) {
                        const allSubItems = subMenu.querySelectorAll('li.widget__categories--sub__menu--list');
                        allSubItems.forEach(subItem => {
                            const subTextSpan = subItem.querySelector('.widget__categories--sub__menu--text');
                            if (subTextSpan) {
                                subTextSpan.style.color = '';
                                subTextSpan.style.fontWeight = '';
                            }
                        });
                    }
                });

                // Eğer kategori filtresi varsa vurgula ve gizle
                if (urlFilters.mainCategory || urlFilters.subCategory) {
                    allMainCategoryItems.forEach(mainItem => {
                        const mainTextSpan = mainItem.querySelector('.widget__categories--menu__text');
                        const mainCategoryName = mainTextSpan ? mainTextSpan.textContent.trim() : '';
                        const mainCategorySlug = generateSlug(mainCategoryName);

                        // Eğer bu ana kategori seçiliyse
                        if (mainCategorySlug === urlFilters.mainCategory) {
                            // Ana kategori text'ini vurgula
                            if (mainTextSpan) {
                                mainTextSpan.style.color = 'var(--secondary-color)';
                                mainTextSpan.style.fontWeight = '600';
                            }

                            // Alt kategorileri göster
                            const subMenu = mainItem.querySelector('.widget__categories--sub__menu');
                            if (subMenu) {
                                subMenu.style.display = 'block';
                                const arrowIcon = mainItem.querySelector('svg.widget__categories--menu__arrowdown--icon');
                                if (arrowIcon) {
                                    arrowIcon.style.transform = 'rotate(180deg)';
                                }
                                mainItem.classList.add('active');

                                // Eğer alt kategori de seçiliyse
                                if (urlFilters.subCategory) {
                                    const allSubItems = subMenu.querySelectorAll('li.widget__categories--sub__menu--list');
                                    allSubItems.forEach(subItem => {
                                        const subTextSpan = subItem.querySelector('.widget__categories--sub__menu--text');
                                        const subCategoryName = subTextSpan ? subTextSpan.textContent.trim() : '';
                                        const subCategorySlug = generateSlug(subCategoryName);

                                        if (subCategorySlug === urlFilters.subCategory) {
                                            // Alt kategori text'ini vurgula
                                            if (subTextSpan) {
                                                subTextSpan.style.color = 'var(--secondary-color)';
                                                subTextSpan.style.fontWeight = '600';
                                            }
                                        }
                                    });
                                }
                            }
                        } else {
                            // Diğer kategorileri gizle
                            mainItem.style.display = 'none';
                        }
                    });
                }
            }

            // Markalar için vurgulama
            if (brandsMenu) {
                const allBrandItems = brandsMenu.querySelectorAll(':scope > li.widget__categories--menu__list');

                // Önce tüm markaları göster ve stillerini sıfırla
                allBrandItems.forEach(brandItem => {
                    brandItem.style.display = '';
                    const brandTextSpan = brandItem.querySelector('.widget__categories--menu__text');
                    if (brandTextSpan) {
                        brandTextSpan.style.color = '';
                        brandTextSpan.style.fontWeight = '';
                    }

                    // Model stillerini de sıfırla ve göster
                    const modelsMenu = brandItem.querySelector('.widget__categories--sub__menu');
                    if (modelsMenu) {
                        const allModelItems = modelsMenu.querySelectorAll(':scope > li.widget__categories--sub__menu--list');
                        allModelItems.forEach(modelItem => {
                            modelItem.style.display = '';
                            const modelTextSpan = modelItem.querySelector('.widget__categories--sub__menu--text');
                            if (modelTextSpan) {
                                modelTextSpan.style.color = '';
                                modelTextSpan.style.fontWeight = '';
                            }

                            // Versiyon stillerini de sıfırla ve göster
                            const versionsMenu = modelItem.querySelector('ul.widget__categories--sub__menu[style*="border-left"]');
                            if (versionsMenu) {
                                const allVersionItems = versionsMenu.querySelectorAll('li.widget__categories--sub__menu--list');
                                allVersionItems.forEach(versionItem => {
                                    versionItem.style.display = '';
                                    const versionTextSpan = versionItem.querySelector('.widget__categories--sub__menu--text');
                                    if (versionTextSpan) {
                                        versionTextSpan.style.color = '';
                                        versionTextSpan.style.fontWeight = '';
                                    }
                                });
                            }
                        });
                    }
                });

                // Eğer marka filtresi varsa vurgula ve gizle
                if (urlFilters.brand || urlFilters.model || urlFilters.version) {
                    allBrandItems.forEach(brandItem => {
                        const brandTextSpan = brandItem.querySelector('.widget__categories--menu__text');
                        const brandName = brandTextSpan ? brandTextSpan.textContent.trim() : '';
                        const brandSlug = generateSlug(brandName);

                        // Eğer bu marka seçiliyse
                        if (brandSlug === urlFilters.brand) {
                            // Marka text'ini vurgula
                            if (brandTextSpan) {
                                brandTextSpan.style.color = 'var(--secondary-color)';
                                brandTextSpan.style.fontWeight = '600';
                            }

                            // Modelleri göster
                            const modelsMenu = brandItem.querySelector('.widget__categories--sub__menu');
                            if (modelsMenu) {
                                modelsMenu.style.display = 'block';
                                const brandArrowIcon = brandItem.querySelector('svg.widget__categories--menu__arrowdown--icon');
                                if (brandArrowIcon) {
                                    brandArrowIcon.style.transform = 'rotate(180deg)';
                                }
                                brandItem.classList.add('active');

                                // Eğer model de seçiliyse
                                if (urlFilters.model) {
                                    const allModelItems = modelsMenu.querySelectorAll(':scope > li.widget__categories--sub__menu--list');
                                    allModelItems.forEach(modelItem => {
                                        const modelTextSpan = modelItem.querySelector('.widget__categories--sub__menu--text');
                                        const modelName = modelTextSpan ? modelTextSpan.textContent.trim() : '';
                                        const modelSlug = generateSlug(modelName);

                                        if (modelSlug === urlFilters.model) {
                                            // Sadece seçili modeli göster
                                            modelItem.style.display = '';

                                            // Model text'ini vurgula
                                            if (modelTextSpan) {
                                                modelTextSpan.style.color = 'var(--secondary-color)';
                                                modelTextSpan.style.fontWeight = '600';
                                            }

                                            // Versiyonları göster
                                            const versionsMenu = modelItem.querySelector('ul.widget__categories--sub__menu[style*="border-left"]');
                                            if (versionsMenu) {
                                                versionsMenu.style.display = 'block';
                                                const modelArrowIcon = modelItem.querySelector('svg.widget__categories--menu__arrowdown--icon');
                                                if (modelArrowIcon) {
                                                    modelArrowIcon.style.transform = 'rotate(180deg)';
                                                }

                                                // Eğer versiyon da seçiliyse sadece vurgula, gizleme
                                                if (urlFilters.version) {
                                                    const allVersionItems = versionsMenu.querySelectorAll('li.widget__categories--sub__menu--list');
                                                    allVersionItems.forEach(versionItem => {
                                                        const versionTextSpan = versionItem.querySelector('.widget__categories--sub__menu--text');
                                                        const versionName = versionTextSpan ? versionTextSpan.textContent.trim() : '';
                                                        const versionSlug = generateSlug(versionName);

                                                        if (versionSlug === urlFilters.version) {
                                                            // Versiyon text'ini vurgula
                                                            if (versionTextSpan) {
                                                                versionTextSpan.style.color = 'var(--secondary-color)';
                                                                versionTextSpan.style.fontWeight = '600';
                                                            }
                                                        }
                                                    });
                                                }
                                            }
                                        } else {
                                            // Diğer modelleri gizle
                                            modelItem.style.display = 'none';
                                        }
                                    });
                                }
                            }
                        } else {
                            // Diğer markaları gizle
                            brandItem.style.display = 'none';
                        }
                    });
                }
            }
        }

        $(document).ready(function () {
            loadProducts();
            setupInfiniteScroll();
            loadShopCategories();
            loadShopBrands();
            loadShopManufacturers();

            // Kategoriler menüsünü aç eğer filtre seçiliyse
            if (urlFilters.mainCategory || urlFilters.subCategory) {
                setTimeout(() => {
                    $('#shop-categories-menu').slideDown(0);
                    $('#categories-arrow').css('transform', 'rotate(180deg)');
                }, 100);
            }

            // Markalar menüsünü aç eğer filtre seçiliyse
            if (urlFilters.brand || urlFilters.model || urlFilters.version) {
                setTimeout(() => {
                    $('#shop-brands-menu').slideDown(0);
                    $('#brands-arrow').css('transform', 'rotate(180deg)');
                }, 100);
            }

            // Üreticiler menüsünü aç eğer filtre seçiliyse
            if (urlFilters.manufacturer) {
                setTimeout(() => {
                    $('#shop-manufacturers-menu').slideDown(0);
                    $('#manufacturers-arrow').css('transform', 'rotate(180deg)');
                }, 100);
            }

            // Fiyat filtresi input alanlarını doldur
            if (urlFilters.minPrice) {
                document.getElementById('Filter-Price-GTE2').value = urlFilters.minPrice;
            }
            if (urlFilters.maxPrice) {
                document.getElementById('Filter-Price-LTE2').value = urlFilters.maxPrice;
            }

            // Arama input'unu doldur
            if (urlFilters.searchTerm) {
                document.getElementById('search-term-input').value = urlFilters.searchTerm;
            }

            // Kategoriler toggle
            $('#categories-toggle').on('click', function () {
                const menu = $('#shop-categories-menu');
                const arrow = $('#categories-arrow');

                if (menu.is(':visible')) {
                    menu.slideUp(300);
                    arrow.css('transform', 'rotate(0deg)');
                } else {
                    menu.slideDown(300);
                    arrow.css('transform', 'rotate(180deg)');
                }
            });

            // Markalar toggle
            $('#brands-toggle').on('click', function () {
                const menu = $('#shop-brands-menu');
                const arrow = $('#brands-arrow');

                if (menu.is(':visible')) {
                    menu.slideUp(300);
                    arrow.css('transform', 'rotate(0deg)');
                } else {
                    menu.slideDown(300);
                    arrow.css('transform', 'rotate(180deg)');
                }
            });

            // Sayfa başına değiştiğinde
            $('#pageSizeSelect').on('change', function () {
                pageSize = parseInt($(this).val());
                currentPage = 1;
                hasMoreProducts = true;
                $('html, body').animate({ scrollTop: 0 }, 300);
                loadProducts(false);
            });

            // Sıralama değiştiğinde
            $('#orderBySelect').on('change', function () {
                const value = $(this).val();
                orderBy = {
                    '1': 'latest',
                    '2': 'bestseller',
                    '3': 'price_asc',
                    '4': 'price_desc'
                }[value] || 'latest';
                currentPage = 1;
                hasMoreProducts = true;
                loadProducts(false);
            });

            // Fiyat filtreleme fonksiyonu
            function applyPriceFilter() {
                const minPriceInput = parseFloat($('#Filter-Price-GTE2').val()) || null;
                const maxPriceInput = parseFloat($('#Filter-Price-LTE2').val()) || null;

                // Query parametreleriyle yeni URL oluştur
                const newUrl = buildFilterUrl({
                    minPrice: minPriceInput,
                    maxPrice: maxPriceInput
                });

                window.location.href = newUrl;
            }

            // Fiyat filtresi butonu
            $('.price__filter--btn').on('click', function (e) {
                e.preventDefault();
                applyPriceFilter();
            });

            // Fiyat input'larında Enter tuşu
            $('#Filter-Price-GTE2, #Filter-Price-LTE2').on('keypress', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    applyPriceFilter();
                }
            });

            // Arama filtreleme fonksiyonu
            function applySearchFilter() {
                const searchTermInput = $('#search-term-input').val().trim() || null;

                // Query parametreleriyle yeni URL oluştur
                const newUrl = buildFilterUrl({
                    searchTerm: searchTermInput
                });

                window.location.href = newUrl;
            }

            // Arama butonu
            $('#search-btn').on('click', function (e) {
                e.preventDefault();
                applySearchFilter();
            });

            // Arama input'unda Enter tuşu
            $('#search-term-input').on('keypress', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    applySearchFilter();
                }
            });
        });

        function loadShopCategories() {
            // Layout'tan kategori verisini al (eğer yüklenmemişse bekle)
            function renderCategories(categories) {
                const categoriesMenu = document.getElementById('shop-categories-menu');
                if (!categoriesMenu || !categories || !Array.isArray(categories)) {
                    return;
                }

                // Wrapper seviyesinde customAccordion'u engelle (sadece bir kez ekle)
                if (!categoriesMenu.hasAttribute('data-custom-handler-added')) {
                    categoriesMenu.setAttribute('data-custom-handler-added', 'true');
                    categoriesMenu.addEventListener('click', function (e) {
                        const clickedMenuItem = e.target.closest('li.widget__categories--menu__list');
                        if (clickedMenuItem) {
                            if (e.target.closest('a') ||
                                e.target.closest('.widget__categories--menu__text') ||
                                e.target.closest('img.widget__categories--menu__img') ||
                                e.target.closest('svg.widget__categories--menu__arrowdown--icon') ||
                                (e.target.tagName === 'path' && e.target.closest('svg.widget__categories--menu__arrowdown--icon'))) {
                                e.stopImmediatePropagation();
                                return;
                            }
                            const categoryContainer = clickedMenuItem.querySelector('div.d-flex.align-items-center');
                            if (categoryContainer && e.target === categoryContainer) {
                                e.stopImmediatePropagation();
                                return;
                            }
                        }
                    }, true);
                }

                categoriesMenu.innerHTML = '';

                categories.forEach(category => {
                    // Ana kategori list item
                    const menuItem = document.createElement('li');
                    menuItem.className = 'widget__categories--menu__list';

                    // Ana kategori container
                    const categoryContainer = document.createElement('div');
                    categoryContainer.className = 'd-flex align-items-center';
                    categoryContainer.style.width = '100%';
                    categoryContainer.style.justifyContent = 'space-between';
                    categoryContainer.style.padding = '0.8rem 1rem';
                    categoryContainer.style.cursor = 'pointer';

                    // Sol taraf container (ikon + metin) - Filtreleme için
                    const categorySlugForMain = generateSlug(category.anA_GRUP_ADI);
                    const leftContainer = document.createElement('a');
                    leftContainer.href = buildFilterUrl({ mainCategory: categorySlugForMain });
                    leftContainer.style.display = 'flex';
                    leftContainer.style.alignItems = 'center';
                    leftContainer.style.gap = '8px';
                    leftContainer.style.flex = '1';
                    leftContainer.style.cursor = 'pointer';
                    leftContainer.style.textDecoration = 'none';
                    leftContainer.style.color = 'inherit';

                    // Kategori ikonu
                    if (category.gruP_IKON) {
                        const icon = document.createElement('img');
                        icon.className = 'widget__categories--menu__img';
                        icon.src = category.gruP_IKON.startsWith('/') ? category.gruP_IKON : '/' + category.gruP_IKON;
                        icon.alt = 'categories-img';
                        leftContainer.appendChild(icon);
                    }

                    // Kategori adı
                    const categoryText = document.createElement('span');
                    categoryText.className = 'widget__categories--menu__text';
                    categoryText.textContent = category.anA_GRUP_ADI || '';
                    categoryText.style.cursor = 'pointer';
                    leftContainer.appendChild(categoryText);

                    categoryContainer.appendChild(leftContainer);

                    // Alt kategoriler varsa ok ikonu ekle
                    let arrowIcon = null;
                    if (category.subCategories && category.subCategories.length > 0) {
                        arrowIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        arrowIcon.className = 'widget__categories--menu__arrowdown--icon';
                        arrowIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                        arrowIcon.setAttribute('width', '12.355');
                        arrowIcon.setAttribute('height', '8.394');
                        arrowIcon.style.flexShrink = '0';
                        arrowIcon.style.marginLeft = 'auto';
                        arrowIcon.style.transition = 'transform 0.3s ease';
                        arrowIcon.style.transform = 'rotate(0deg)';
                        arrowIcon.style.cursor = 'pointer';
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        path.setAttribute('d', 'M15.138,8.59l-3.961,3.952L7.217,8.59,6,9.807l5.178,5.178,5.178-5.178Z');
                        path.setAttribute('transform', 'translate(-6 -8.59)');
                        path.setAttribute('fill', 'currentColor');
                        arrowIcon.appendChild(path);

                        categoryContainer.appendChild(arrowIcon);
                    }

                    menuItem.appendChild(categoryContainer);

                    // menuItem seviyesinde click event'lerini kontrol et (customAccordion'dan önce)
                    menuItem.addEventListener('click', function (e) {
                        // ArrowIcon'a tıklandıysa, accordion'u aç/kapa
                        if (arrowIcon && (e.target === arrowIcon ||
                            e.target.closest('svg.widget__categories--menu__arrowdown--icon') === arrowIcon ||
                            (e.target.tagName === 'path' && e.target.closest('svg') === arrowIcon))) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            const subMenu = menuItem.querySelector('.widget__categories--sub__menu');
                            if (subMenu) {
                                const isVisible = subMenu.style.display !== 'none';
                                if (isVisible) {
                                    $(subMenu).slideUp(300);
                                    arrowIcon.style.transform = 'rotate(0deg)';
                                    menuItem.classList.remove('active');
                                } else {
                                    $(subMenu).slideDown(300);
                                    arrowIcon.style.transform = 'rotate(180deg)';
                                    menuItem.classList.add('active');
                                }
                            }
                            return false;
                        }

                        // leftContainer veya içindeki elementlere tıklandıysa, sadece customAccordion'u engelle
                        if (e.target === leftContainer ||
                            e.target.closest('a') === leftContainer ||
                            e.target.closest('.widget__categories--menu__text') ||
                            e.target.closest('img.widget__categories--menu__img')) {
                            e.stopImmediatePropagation();
                            return;
                        }

                        // Boş alanlara tıklandıysa, accordion'u aç/kapa
                        if (arrowIcon) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            const subMenu = menuItem.querySelector('.widget__categories--sub__menu');
                            if (subMenu) {
                                const isVisible = subMenu.style.display !== 'none';
                                if (isVisible) {
                                    $(subMenu).slideUp(300);
                                    arrowIcon.style.transform = 'rotate(0deg)';
                                    menuItem.classList.remove('active');
                                } else {
                                    $(subMenu).slideDown(300);
                                    arrowIcon.style.transform = 'rotate(180deg)';
                                    menuItem.classList.add('active');
                                }
                            }
                            return false;
                        }
                    }, true);

                    // Alt kategoriler varsa sub menu oluştur
                    if (category.subCategories && category.subCategories.length > 0) {
                        const subMenu = document.createElement('ul');
                        subMenu.className = 'widget__categories--sub__menu';
                        subMenu.style.display = 'none'; // Başlangıçta gizli

                        category.subCategories.forEach(subCategory => {
                            const subMenuItem = document.createElement('li');
                            subMenuItem.className = 'widget__categories--sub__menu--list';
                            subMenuItem.style.padding = '0 1rem 0.8rem 2rem';
                            const subLink = document.createElement('a');
                            subLink.className = 'widget__categories--sub__menu--link d-flex align-items-center';
                            const categorySlug = generateSlug(category.anA_GRUP_ADI);
                            const subCategorySlug = generateSlug(subCategory.alT_GRUP_ADI);
                            subLink.href = buildFilterUrl({ mainCategory: categorySlug, subCategory: subCategorySlug });

                            // Alt kategori ikonu (ana kategorinin ikonunu kullan)
                            if (category.gruP_IKON) {
                                const subIcon = document.createElement('img');
                                subIcon.className = 'widget__categories--sub__menu--img';
                                subIcon.style.width = '1.8rem';
                                subIcon.src = category.gruP_IKON.startsWith('/') ? category.gruP_IKON : '/' + category.gruP_IKON;
                                subIcon.alt = 'categories-img';
                                subLink.appendChild(subIcon);
                            }

                            // Alt kategori adı
                            const subText = document.createElement('span');
                            subText.className = 'widget__categories--sub__menu--text';
                            subText.textContent = subCategory.alT_GRUP_ADI || '';
                            subLink.appendChild(subText);

                            subMenuItem.appendChild(subLink);
                            subMenu.appendChild(subMenuItem);
                        });

                        menuItem.appendChild(subMenu);

                        // Ok yönünü CSS active class'ına göre değiştir (arrowIcon varsa)
                        if (arrowIcon) {
                            // MutationObserver ile active class değişikliğini dinle
                            const observer = new MutationObserver(function (mutations) {
                                mutations.forEach(function (mutation) {
                                    if (mutation.attributeName === 'class') {
                                        if (menuItem.classList.contains('active')) {
                                            arrowIcon.style.transform = 'rotate(180deg)'; // Açıkken yukarı bakıyor
                                        } else {
                                            arrowIcon.style.transform = 'rotate(0deg)'; // Kapalıyken aşağı bakıyor
                                        }
                                    }
                                });
                            });
                            observer.observe(menuItem, { attributes: true, attributeFilter: ['class'] });
                        }
                    }

                    categoriesMenu.appendChild(menuItem);
                });

                // Kategoriler render edildikten sonra aktif filtreleri vurgula
                highlightActiveFilters();
                renderActiveFilters();
            }

            // Eğer kategori verisi zaten yüklenmişse direkt render et
            if (window.categoriesData) {
                renderCategories(window.categoriesData);
            } else {
                // Kategori verisi henüz yüklenmemişse, yüklenene kadar bekle
                let checkCount = 0;
                const checkInterval = setInterval(function () {
                    checkCount++;
                    if (window.categoriesData) {
                        clearInterval(checkInterval);
                        renderCategories(window.categoriesData);
                    } else if (checkCount > 50) {
                        // 5 saniye sonra timeout (50 * 100ms)
                        clearInterval(checkInterval);
                        console.warn('Kategori verisi yüklenemedi');
                    }
                }, 100);
            }
        }

        function loadShopBrands() {
            const brandsMenu = document.getElementById('shop-brands-menu');
            if (!brandsMenu) {
                console.error('Markalar menüsü bulunamadı');
                return;
            }

            function renderBrands(brandsData) {
                // Wrapper seviyesinde customAccordion'u engelle (sadece bir kez ekle)
                if (!brandsMenu.hasAttribute('data-custom-handler-added')) {
                    brandsMenu.setAttribute('data-custom-handler-added', 'true');
                    brandsMenu.addEventListener('click', function (e) {
                        const clickedMenuItem = e.target.closest('li.widget__categories--menu__list');
                        if (clickedMenuItem) {
                            if (e.target.closest('a') ||
                                e.target.closest('.widget__categories--menu__text') ||
                                e.target.closest('img.widget__categories--menu__img') ||
                                e.target.closest('svg.widget__categories--menu__arrowdown--icon') ||
                                (e.target.tagName === 'path' && e.target.closest('svg.widget__categories--menu__arrowdown--icon'))) {
                                e.stopImmediatePropagation();
                                return;
                            }
                            const brandContainer = clickedMenuItem.querySelector('div.d-flex.align-items-center');
                            if (brandContainer && e.target === brandContainer) {
                                e.stopImmediatePropagation();
                                return;
                            }
                        }
                    }, true);
                }

                brandsMenu.innerHTML = '';

                if (!brandsData || !Array.isArray(brandsData) || brandsData.length === 0) {
                    console.warn('Marka verisi yok');
                    return;
                }

                brandsData.forEach(brand => {
                    // Ana marka list item
                    const brandItem = document.createElement('li');
                    brandItem.className = 'widget__categories--menu__list';

                    // Ana marka container
                    const brandContainer = document.createElement('div');
                    brandContainer.className = 'd-flex align-items-center';
                    brandContainer.style.width = '100%';
                    brandContainer.style.justifyContent = 'space-between';
                    brandContainer.style.padding = '0.8rem 1rem';
                    brandContainer.style.cursor = 'pointer';

                    // Sol taraf container (ikon + metin) - Filtreleme için
                    const markaAdi = brand.markA_ADI || brand.MARKA_ADI || '';
                    const brandSlugForMain = generateSlug(markaAdi);
                    const leftContainer = document.createElement('a');
                    leftContainer.href = buildFilterUrl({ brand: brandSlugForMain });
                    leftContainer.style.display = 'flex';
                    leftContainer.style.alignItems = 'center';
                    leftContainer.style.gap = '8px';
                    leftContainer.style.flex = '1';
                    leftContainer.style.cursor = 'pointer';
                    leftContainer.style.textDecoration = 'none';
                    leftContainer.style.color = 'inherit';

                    // Marka logosu
                    if (markaAdi) {
                        const brandLogo = document.createElement('img');
                        brandLogo.className = 'widget__categories--menu__img';
                        brandLogo.style.width = '5rem';
                        brandLogo.style.height = 'auto';
                        const brandLogoPath = markaAdi.toLowerCase();
                        brandLogo.src = `/assets/img/logo/${brandLogoPath}.webp`;
                        brandLogo.alt = 'categories-img';
                        brandLogo.onerror = function () {
                            const brandSlug = markaAdi.toLowerCase().replace(/\s+/g, '-');
                            brandLogo.src = `/assets/img/logo/${brandSlug}.webp`;
                        };
                        leftContainer.appendChild(brandLogo);
                    }

                    // Marka adı
                    const brandText = document.createElement('span');
                    brandText.className = 'widget__categories--menu__text';
                    brandText.textContent = markaAdi.toUpperCase();
                    brandText.style.cursor = 'pointer';
                    brandText.setAttribute('data-brand-slug', brandSlugForMain);
                    leftContainer.appendChild(brandText);

                    brandContainer.appendChild(leftContainer);

                    // Modeller varsa ok ikonu ekle
                    let brandArrowIcon = null;
                    if (brand.modelsYears && brand.modelsYears.length > 0) {
                        brandArrowIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        brandArrowIcon.className = 'widget__categories--menu__arrowdown--icon';
                        brandArrowIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                        brandArrowIcon.setAttribute('width', '12.355');
                        brandArrowIcon.setAttribute('height', '8.394');
                        brandArrowIcon.style.flexShrink = '0';
                        brandArrowIcon.style.marginLeft = 'auto';
                        brandArrowIcon.style.transition = 'transform 0.3s ease';
                        brandArrowIcon.style.transform = 'rotate(0deg)';
                        brandArrowIcon.style.cursor = 'pointer';
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        path.setAttribute('d', 'M15.138,8.59l-3.961,3.952L7.217,8.59,6,9.807l5.178,5.178,5.178-5.178Z');
                        path.setAttribute('transform', 'translate(-6 -8.59)');
                        path.setAttribute('fill', 'currentColor');
                        brandArrowIcon.appendChild(path);
                        brandContainer.appendChild(brandArrowIcon);
                    }

                    brandItem.appendChild(brandContainer);

                    // brandItem seviyesinde click event'lerini kontrol et
                    // BUBBLE phase'de çalışır (false) - modelItem'ın capture listener'ından SONRA
                    brandItem.addEventListener('click', function (e) {
                        // ArrowIcon'a tıklandıysa, accordion'u aç/kapa
                        if (brandArrowIcon && (e.target === brandArrowIcon ||
                            e.target.closest('svg.widget__categories--menu__arrowdown--icon') === brandArrowIcon ||
                            (e.target.tagName === 'path' && e.target.closest('svg') === brandArrowIcon))) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            const modelsMenu = brandItem.querySelector('.widget__categories--sub__menu');
                            if (modelsMenu) {
                                const isVisible = modelsMenu.style.display !== 'none';
                                if (isVisible) {
                                    $(modelsMenu).slideUp(300);
                                    brandArrowIcon.style.transform = 'rotate(0deg)';
                                    brandItem.classList.remove('active');
                                } else {
                                    $(modelsMenu).slideDown(300);
                                    brandArrowIcon.style.transform = 'rotate(180deg)';
                                    brandItem.classList.add('active');
                                }
                            }
                            return false;
                        }

                        // leftContainer veya içindeki elementlere tıklandıysa, sadece customAccordion'u engelle
                        if (e.target === leftContainer ||
                            e.target.closest('a') === leftContainer ||
                            e.target.closest('.widget__categories--menu__text') ||
                            e.target.closest('img.widget__categories--menu__img')) {
                            e.stopImmediatePropagation();
                            return;
                        }

                        // Boş alanlara tıklandıysa, accordion'u aç/kapa
                        if (brandArrowIcon) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            const modelsMenu = brandItem.querySelector('.widget__categories--sub__menu');
                            if (modelsMenu) {
                                const isVisible = modelsMenu.style.display !== 'none';
                                if (isVisible) {
                                    $(modelsMenu).slideUp(300);
                                    brandArrowIcon.style.transform = 'rotate(0deg)';
                                    brandItem.classList.remove('active');
                                } else {
                                    $(modelsMenu).slideDown(300);
                                    brandArrowIcon.style.transform = 'rotate(180deg)';
                                    brandItem.classList.add('active');
                                }
                            }
                            return false;
                        }
                    }, false); // BUBBLE phase - modelItem'ın listener'ından SONRA çalışır

                    // Modeller varsa sub menu oluştur
                    if (brand.modelsYears && brand.modelsYears.length > 0) {
                        const modelsMenu = document.createElement('ul');
                        modelsMenu.className = 'widget__categories--sub__menu';
                        modelsMenu.style.display = 'none'; // Başlangıçta gizli

                        brand.modelsYears.forEach(model => {
                            // Model list item
                            const modelItem = document.createElement('li');
                            modelItem.className = 'widget__categories--sub__menu--list';
                            modelItem.style.padding = '0 1rem 0.8rem 2.5rem';

                            // Model container
                            const modelContainer = document.createElement('div');
                            modelContainer.className = 'd-flex align-items-center';
                            modelContainer.style.width = '100%';
                            modelContainer.style.justifyContent = 'space-between';
                            modelContainer.style.cursor = 'pointer';

                            // Sol taraf container (ikon + metin) - Filtreleme için
                            const markaAdiForModel = brand.markA_ADI || brand.MARKA_ADI || '';
                            const brandSlugForModel = generateSlug(markaAdiForModel);
                            const modelSlugForModel = generateSlug(model.modeL_ADI || '');
                            const modelLeftContainer = document.createElement('a');
                            modelLeftContainer.href = buildFilterUrl({ brand: brandSlugForModel, model: modelSlugForModel });
                            modelLeftContainer.style.display = 'flex';
                            modelLeftContainer.style.alignItems = 'center';
                            modelLeftContainer.style.gap = '8px';
                            modelLeftContainer.style.flex = '1';
                            modelLeftContainer.style.cursor = 'pointer';
                            modelLeftContainer.style.textDecoration = 'none';
                            modelLeftContainer.style.color = 'inherit';

                            // Model logosu
                            if (markaAdiForModel) {
                                const modelLogo = document.createElement('img');
                                modelLogo.className = 'widget__categories--sub__menu--img';
                                const brandLogoPath = markaAdiForModel.toLowerCase();
                                modelLogo.src = `/assets/img/logo/${brandLogoPath}.webp`;
                                modelLogo.alt = 'categories-img';
                                modelLogo.onerror = function () {
                                    const brandSlug = markaAdiForModel.toLowerCase().replace(/\s+/g, '-');
                                    modelLogo.src = `/assets/img/logo/${brandSlug}.webp`;
                                };
                                modelLeftContainer.appendChild(modelLogo);
                            }

                            // Model adı
                            const modelText = document.createElement('span');
                            modelText.className = 'widget__categories--sub__menu--text';
                            modelText.textContent = (model.modeL_ADI || '').toUpperCase();
                            modelText.style.cursor = 'pointer';
                            modelText.setAttribute('data-brand-slug', brandSlugForModel);
                            modelText.setAttribute('data-model-slug', modelSlugForModel);
                            modelLeftContainer.appendChild(modelText);

                            modelContainer.appendChild(modelLeftContainer);

                            // Versiyonlar varsa ok ikonu ekle
                            let modelArrowIcon = null;
                            if (model.years && model.years.length > 0) {
                                modelArrowIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                                modelArrowIcon.className = 'widget__categories--menu__arrowdown--icon';
                                modelArrowIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                                modelArrowIcon.setAttribute('width', '12.355');
                                modelArrowIcon.setAttribute('height', '8.394');
                                modelArrowIcon.style.flexShrink = '0';
                                modelArrowIcon.style.marginLeft = 'auto';
                                modelArrowIcon.style.transition = 'transform 0.3s ease';
                                modelArrowIcon.style.transform = 'rotate(0deg)';
                                modelArrowIcon.style.cursor = 'pointer';
                                const modelPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                modelPath.setAttribute('d', 'M15.138,8.59l-3.961,3.952L7.217,8.59,6,9.807l5.178,5.178,5.178-5.178Z');
                                modelPath.setAttribute('transform', 'translate(-6 -8.59)');
                                modelPath.setAttribute('fill', 'currentColor');
                                modelArrowIcon.appendChild(modelPath);
                                // modelArrowIcon'a doğrudan event listener ekle
                                // Bu listener capture phase'de çalışır ve HERKESten önce çalışır
                                modelArrowIcon.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();

                                    const versionsMenu = modelItem.querySelector('ul.widget__categories--sub__menu[style*="border-left"]');
                                    if (versionsMenu) {
                                        const isVisible = versionsMenu.style.display !== 'none';
                                        if (isVisible) {
                                            versionsMenu.style.display = 'none';
                                            modelArrowIcon.style.transform = 'rotate(0deg)';
                                        } else {
                                            versionsMenu.style.display = 'block';
                                            modelArrowIcon.style.transform = 'rotate(180deg)';
                                        }
                                    }
                                    return false;
                                }, true);

                                modelContainer.appendChild(modelArrowIcon);
                            }

                            modelItem.appendChild(modelContainer);

                            // modelItem seviyesinde click event'lerini kontrol et
                            modelItem.addEventListener('click', function (e) {
                                // modelLeftContainer veya içindeki elementlere tıklandıysa, sadece customAccordion'u engelle
                                if (e.target === modelLeftContainer ||
                                    e.target.closest('a') === modelLeftContainer ||
                                    e.target.closest('.widget__categories--sub__menu--text') ||
                                    e.target.closest('img.widget__categories--sub__menu--img')) {
                                    e.stopImmediatePropagation();
                                    return;
                                }

                                // Boş alanlara tıklandıysa, versiyon accordion'unu aç/kapa
                                if (modelArrowIcon) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    const versionsMenu = modelItem.querySelector('ul.widget__categories--sub__menu[style*="border-left"]');
                                    if (versionsMenu) {
                                        const isVisible = versionsMenu.style.display !== 'none';
                                        if (isVisible) {
                                            versionsMenu.style.display = 'none';
                                            modelArrowIcon.style.transform = 'rotate(0deg)';
                                        } else {
                                            versionsMenu.style.display = 'block';
                                            modelArrowIcon.style.transform = 'rotate(180deg)';
                                        }
                                    }
                                    return false;
                                }
                            }, true);

                            // Versiyonlar varsa sub-sub menu oluştur
                            let versionsMenu = null;
                            if (model.years && model.years.length > 0) {
                                versionsMenu = document.createElement('ul');
                                versionsMenu.className = 'widget__categories--sub__menu';
                                versionsMenu.style.display = 'none'; // Başlangıçta gizli
                                versionsMenu.style.borderLeft = '1px solid #e0e0e0';
                                versionsMenu.style.borderTop = 'unset !important';
                                versionsMenu.style.paddingLeft = '1rem';
                                versionsMenu.style.marginLeft = '1rem';

                                model.years.forEach(year => {
                                    const versionItem = document.createElement('li');
                                    versionItem.className = 'widget__categories--sub__menu--list';
                                    versionItem.style.padding = '0 1rem 0.8rem 2rem';

                                    // Versiyon adını al (kasA_ADI property'sini kullan)
                                    let versionValue = '';
                                    if (typeof year === 'object' && year !== null) {
                                        versionValue = year.kasA_ADI || year.KASA_ADI || String(year);
                                    } else {
                                        versionValue = String(year || '');
                                    }

                                    const versionLink = document.createElement('a');
                                    versionLink.className = 'widget__categories--sub__menu--link d-flex align-items-center';
                                    const markaAdiForUrl = generateSlug(brand.markA_ADI || brand.MARKA_ADI || '');
                                    const modelAdiForUrl = generateSlug(model.modeL_ADI || '');
                                    const versionForUrl = generateSlug(versionValue);
                                    versionLink.href = buildFilterUrl({ brand: markaAdiForUrl, model: modelAdiForUrl, version: versionForUrl });
                                    versionLink.setAttribute('data-brand-slug', markaAdiForUrl);
                                    versionLink.setAttribute('data-model-slug', modelAdiForUrl);
                                    versionLink.setAttribute('data-version-slug', versionForUrl);

                                    const versionText = document.createElement('span');
                                    versionText.className = 'widget__categories--sub__menu--text';
                                    versionText.textContent = versionValue.toUpperCase();
                                    versionLink.appendChild(versionText);

                                    versionItem.appendChild(versionLink);
                                    versionsMenu.appendChild(versionItem);
                                });

                                modelItem.appendChild(versionsMenu);
                            }

                            modelsMenu.appendChild(modelItem);
                        });

                        brandItem.appendChild(modelsMenu);

                        // Ok yönünü CSS active class'ına göre değiştir (brandArrowIcon varsa)
                        if (brandArrowIcon) {
                            // MutationObserver ile active class değişikliğini dinle
                            const observer = new MutationObserver(function (mutations) {
                                mutations.forEach(function (mutation) {
                                    if (mutation.attributeName === 'class') {
                                        if (brandItem.classList.contains('active')) {
                                            brandArrowIcon.style.transform = 'rotate(180deg)'; // Açıkken yukarı bakıyor
                                        } else {
                                            brandArrowIcon.style.transform = 'rotate(0deg)'; // Kapalıyken aşağı bakıyor
                                        }
                                    }
                                });
                            });
                            observer.observe(brandItem, { attributes: true, attributeFilter: ['class'] });
                        }
                    }

                    brandsMenu.appendChild(brandItem);
                });

                // Markalar render edildikten sonra aktif filtreleri vurgula
                highlightActiveFilters();
                renderActiveFilters();
            }

            // Eğer marka verisi zaten yüklenmişse direkt render et
            if (window.brandsModelsYearsData) {
                renderBrands(window.brandsModelsYearsData);
            } else {
                // Marka verisi henüz yüklenmemişse, yüklenene kadar bekle
                let checkCount = 0;
                const checkInterval = setInterval(function () {
                    checkCount++;
                    if (window.brandsModelsYearsData) {
                        clearInterval(checkInterval);
                        renderBrands(window.brandsModelsYearsData);
                    } else if (checkCount > 50) {
                        // 5 saniye sonra timeout (50 * 100ms)
                        clearInterval(checkInterval);
                        console.warn('Marka verisi yüklenemedi');
                    }
                }, 100);
            }
        }

        async function loadShopManufacturers() {
            const manufacturersMenu = document.getElementById('shop-manufacturers-menu');
            if (!manufacturersMenu) {
                console.error('Üreticiler menüsü bulunamadı');
                return;
            }

            try {
                const response = await makeRequest('/kategori/ureticiler', 'GET');
                if (!response || !Array.isArray(response)) {
                    console.error('Üretici verisi beklenen formatta değil:', response);
                    return;
                }
                manufacturersMenu.innerHTML = ''; // Mevcut içeriği temizle

                response.forEach((manufacturer, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'widget__form--check__list';

                    // Label container (logo + text)
                    const label = document.createElement('label');
                    label.className = 'widget__form--check__label d-flex align-items-center';
                    label.style.gap = '8px';
                    label.setAttribute('for', `manufacturer-check-${index}`);

                    // Üretici adı
                    const manufacturerName = manufacturer.markA_ADI || manufacturer.MARKA_ADI || '';
                    const manufacturerSlug = generateSlug(manufacturerName);

                    // Üretici logosu
                    if (manufacturerName) {
                        const manufacturerLogo = document.createElement('img');
                        manufacturerLogo.className = 'widget__categories--menu__img';
                        manufacturerLogo.style.width = '5rem';
                        manufacturerLogo.style.height = 'auto';
                        manufacturerLogo.alt = 'categories-img';

                        // Önce markA_LOGO property'sini kontrol et
                        if (manufacturer.markA_LOGO) {
                            manufacturerLogo.src = manufacturer.markA_LOGO.startsWith('/')
                                ? manufacturer.markA_LOGO
                                : '/' + manufacturer.markA_LOGO;
                        } else {
                            // Fallback: logo path'i oluştur
                            const logoPath = manufacturerName.toLowerCase();
                            manufacturerLogo.src = `/assets/img/logo/${logoPath}.webp`;
                            manufacturerLogo.onerror = function () {
                                // Alternatif olarak slug formatını dene
                                const slug = manufacturerName.toLowerCase().replace(/\s+/g, '-');
                                manufacturerLogo.src = `/assets/img/logo/${slug}.webp`;
                            };
                        }

                        label.appendChild(manufacturerLogo);
                    }

                    // Üretici adı text
                    const manufacturerText = document.createElement('span');
                    manufacturerText.className = 'widget__categories--sub__menu--text';
                    manufacturerText.textContent = manufacturerName;
                    label.appendChild(manufacturerText);

                    // Checkbox
                    const checkbox = document.createElement('input');
                    checkbox.className = 'widget__form--check__input';
                    checkbox.id = `manufacturer-check-${index}`;
                    checkbox.type = 'checkbox';
                    checkbox.value = manufacturerName;

                    // Eğer bu üretici seçiliyse checkbox'ı işaretle
                    if (urlFilters.manufacturer && urlFilters.manufacturer === manufacturerSlug) {
                        checkbox.checked = true;
                        manufacturerText.style.color = 'var(--secondary-color)';
                        manufacturerText.style.fontWeight = '600';
                    }

                    // Checkbox değiştiğinde filtreleme yap
                    checkbox.addEventListener('change', function(e) {
                        // Önce tüm checkbox'ları temizle (sadece bir tane seçilebilir)
                        const allCheckboxes = manufacturersMenu.querySelectorAll('input[type="checkbox"]');
                        allCheckboxes.forEach(cb => {
                            if (cb !== checkbox) {
                                cb.checked = false;
                            }
                        });

                        // URL oluştur - checkbox seçiliyse üretici ekle, değilse null
                        const newUrl = buildFilterUrl({
                            manufacturer: checkbox.checked ? manufacturerSlug : null
                        });

                        window.location.href = newUrl;
                    });

                    // Checkmark span
                    const checkmark = document.createElement('span');
                    checkmark.className = 'widget__form--checkmark';

                    listItem.appendChild(label);
                    listItem.appendChild(checkbox);
                    listItem.appendChild(checkmark);

                    manufacturersMenu.appendChild(listItem);
                });
            } catch (error) {
                console.error('Üreticiler yüklenirken hata oluştu:', error);
            }
        }

        function setupInfiniteScroll() {
            let scrollTimeout;

            $(window).on('scroll', function () {
                // Debounce - her scroll'da değil, scroll bittiğinde kontrol et
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(function () {
                    // Sayfa sonuna yakın mıyız?
                    const scrollTop = $(window).scrollTop();
                    const windowHeight = $(window).height();
                    const documentHeight = $(document).height();
                    const distanceFromBottom = documentHeight - (scrollTop + windowHeight);

                    // 500px kala yüklemeye başla
                    if (distanceFromBottom < 500) {
                        if (!isLoading && hasMoreProducts) {
                            currentPage++;
                            loadProducts(true); // Append mode
                        } else {
                        }
                    }
                }, 100); // 100ms debounce
            });
        }

        async function loadProducts(append = false) {
            if (isLoading) {
                return;
            }
            isLoading = true;

            try {
                // Loading göstergeleri
                const loaderGrid = document.getElementById('infinite-scroll-loader');
                const allLoadedGrid = document.getElementById('all-products-loaded');

                if (append) {
                    if (loaderGrid) loaderGrid.style.display = 'block';
                    if (allLoadedGrid) allLoadedGrid.style.display = 'none';
                } else {
                    // İlk yükleme - skeleton göster
                    SkeletonLoader.showProductSkeleton('shop-products-grid', pageSize);

                    if (loaderGrid) loaderGrid.style.display = 'none';
                    if (allLoadedGrid) allLoadedGrid.style.display = 'none';
                }

                // Query parametreleri oluştur
                const params = new URLSearchParams({
                    pageNumber: currentPage,
                    pageSize: pageSize
                });

                if (orderBy) params.append('orderBy', orderBy);
                if (minPrice !== null) params.append('minPrice', minPrice);
                if (maxPrice !== null) params.append('maxPrice', maxPrice);

                // URL filtrelerini ekle
                if (urlFilters.mainCategory) params.append('mainCategory', urlFilters.mainCategory);
                if (urlFilters.subCategory) params.append('subCategory', urlFilters.subCategory);
                if (urlFilters.brand) params.append('brand', urlFilters.brand);
                if (urlFilters.model) params.append('model', urlFilters.model);
                if (urlFilters.version) params.append('year', urlFilters.version);
                if (urlFilters.manufacturer) params.append('manufacturer', urlFilters.manufacturer);
                if (urlFilters.searchTerm) params.append('searchTerm', urlFilters.searchTerm);

                // API'den ürünleri çek
                const response = await makeRequest(`/urun/listele?${params.toString()}`, 'GET');

                // Response formatını kontrol et
                let products = null;

                if (Array.isArray(response)) {
                    products = response;
                    // Eğer totalCount yoksa, tahmin et
                    if (!append) totalProductCount = response.length;
                } else if (response && response.data && Array.isArray(response.data)) {
                    products = response.data;
                    totalProductCount = response.totalCount || response.total || totalProductCount;
                } else if (response && response.products && Array.isArray(response.products)) {
                    products = response.products;
                    totalProductCount = response.totalCount || response.total || totalProductCount;
                }

                // Loading göstergelerini gizle
                if (loaderGrid) loaderGrid.style.display = 'none';

                // Hata kontrolü
                if (!products || products.length === 0) {
                    if (!append) {
                        const containerGrid = document.getElementById('shop-products-grid');
                        if (containerGrid) containerGrid.innerHTML = '<div class="col-12 text-center"><p class="text-muted">Aradığınız kriterlere uygun ürün bulunmamaktadır.</p></div>';
                        totalProductCount = 0;
                        updateProductCount();
                    }
                    hasMoreProducts = false;
                    if (allLoadedGrid) allLoadedGrid.style.display = 'block';
                    return;
                }

                // Daha fazla ürün var mı kontrolü
                if (products.length < pageSize) {
                    hasMoreProducts = false;
                    if (allLoadedGrid) allLoadedGrid.style.display = 'block';
                } else {
                }

                // Ürünleri grid view'a render et
                renderProducts('shop-products-grid', products, append);

                // Ürün sayısını güncelle
                updateProductCount();

            } catch (error) {
                console.error('Ürünler yüklenirken hata oluştu:', error);
                const loaderGrid = document.getElementById('infinite-scroll-loader');
                if (loaderGrid) loaderGrid.style.display = 'none';

                if (!append) {
                    const containerGrid = document.getElementById('shop-products-grid');
                    if (containerGrid) containerGrid.innerHTML = '<div class="col-12 text-center"><p class="text-danger">Ürünler yüklenirken bir hata oluştu.</p></div>';
                }
            } finally {
                isLoading = false;
            }
        }

        function updateProductCount() {
            const countElement = document.querySelector('.product__showing--count');
            if (countElement) {
                // Grid veya list'ten hangisi aktifse onu say (her ikisi de aynı sayıda olmalı)
                const currentLoaded = document.querySelectorAll('#shop-products-grid > .custom-col').length;

                if (totalProductCount === 0) {
                    countElement.textContent = '0 sonuç';
                } else if (totalProductCount > 0 && currentLoaded < totalProductCount) {
                    countElement.textContent = `${totalProductCount} üründen ${currentLoaded} tanesi gösteriliyor`;
                } else if (totalProductCount > 0) {
                    countElement.textContent = `Toplam ${totalProductCount} ürün`;
                } else {
                    countElement.textContent = `${currentLoaded} ürün gösteriliyor`;
                }
            }
        }

        function renderProducts(containerId, products, append = false) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Row'a flexbox ekle (tüm kolonların aynı yükseklikte olması için)
            container.style.display = 'flex';
            container.style.flexWrap = 'wrap';

            // Container'ı temizle (sadece append değilse)
            if (!append) {
                container.innerHTML = '';
            }

            // Her ürün için kart oluştur
            products.forEach(product => {
                const productCard = createProductCard(product);
                container.appendChild(productCard);
            });
        }

        function createProductCard(product) {
            // Col div oluştur
            const colDiv = document.createElement('div');
            colDiv.className = 'col-lg-4 col-md-4 col-sm-6 col-6 custom-col mb-30';
            colDiv.style.display = 'flex';
            colDiv.style.flexDirection = 'column';

            // Article oluştur
            const article = document.createElement('article');
            article.className = 'product__card';
            article.style.height = '100%';
            article.style.display = 'flex';
            article.style.flexDirection = 'column';

            // Thumbnail div
            const thumbnailDiv = document.createElement('div');
            thumbnailDiv.className = 'product__card--thumbnail';

            // Thumbnail link
            const thumbnailLink = document.createElement('a');
            thumbnailLink.className = 'product__card--thumbnail__link display-block';
            const productId = product.id;
            const productName = generateSlug(product.stoK_ADI);
            const productCode =product.stoK_KODU;
            thumbnailLink.href = `/urun/${productName}/${productCode}`;

            // Ürün resmi
            const primaryImg = document.createElement('img');
            primaryImg.className = 'product__card--thumbnail__img product__primary--img';
            primaryImg.loading = 'lazy';
            let imagePath = product.vitriN_FOTO || product.VITRIN_FOTO;
            if (!imagePath) {
                const dosyaKonum = product.dosyA_KONUM || product.DOSYA_KONUM;
                if (dosyaKonum) {
                    imagePath = dosyaKonum.split(';')[0].trim();
                }
            }
            if (!imagePath) {
                imagePath = 'assets/img/product/placeholder.webp';
            }
            primaryImg.src = imagePath.startsWith('/') ? imagePath : '/' + imagePath;
            primaryImg.alt = product.stoK_ADI || product.STOK_ADI || 'Ürün';

            // Secondary img
            const secondaryImg = document.createElement('img');
            secondaryImg.className = 'product__card--thumbnail__img product__secondary--img';
            secondaryImg.loading = 'lazy';
            const dosyaKonum = product.dosyA_KONUM || product.DOSYA_KONUM;
            let secondaryImagePath = imagePath;
            if (dosyaKonum && dosyaKonum.includes(';')) {
                const paths = dosyaKonum.split(';');
                if (paths.length > 1) {
                    secondaryImagePath = paths[1].trim();
                }
            }
            secondaryImg.src = secondaryImagePath.startsWith('/') ? secondaryImagePath : '/' + secondaryImagePath;
            secondaryImg.alt = product.stoK_ADI || product.STOK_ADI || 'Ürün';

            thumbnailLink.appendChild(primaryImg);
            thumbnailLink.appendChild(secondaryImg);
            thumbnailDiv.appendChild(thumbnailLink);

            // Content div
            const contentDiv = document.createElement('div');
            contentDiv.className = 'product__card--content d-flex flex-column align-items-center justify-content-center text-center';
            contentDiv.style.flex = '1';
            contentDiv.style.display = 'flex';
            contentDiv.style.flexDirection = 'column';
            contentDiv.style.justifyContent = 'space-between';

            // Ürün adı
            const titleH3 = document.createElement('h3');
            titleH3.className = 'product__card--title';
            titleH3.style.flex = '1';
            titleH3.style.minHeight = '48px';
            titleH3.style.display = 'flex';
            titleH3.style.alignItems = 'center';
            titleH3.style.justifyContent = 'center';
            const titleLink = document.createElement('a');
            titleLink.href = `/urun/${productName}/${productCode}`;
            titleLink.textContent = product.stoK_ADI || product.STOK_ADI || 'Ürün Adı';
            titleH3.appendChild(titleLink);

            // OEM Kodu
            const oemH5 = document.createElement('h4');
            oemH5.className = 'product__card--title text-muted';
            oemH5.style.height = '24px';
            oemH5.style.display = 'flex';
            oemH5.style.alignItems = 'center';
            oemH5.style.justifyContent = 'center';
            oemH5.style.margin = '8px 0';
            const oemKodu = product.oeM_KODU || product.OEM_KODU;
            oemH5.textContent = oemKodu || '';

            // Marka logosu
            const brandDiv = document.createElement('div');
            brandDiv.className = 'product__card--title';
            brandDiv.style.height = '100px';
            brandDiv.style.display = 'flex';
            brandDiv.style.alignItems = 'center';
            brandDiv.style.justifyContent = 'center';
            brandDiv.style.margin = '8px 0';
            const brandImg = document.createElement('img');
            brandImg.style.width = '100px';
            brandImg.style.maxWidth = '100px';
            brandImg.style.height = 'auto';
            brandImg.style.objectFit = 'contain';
            const brandLogoPath = product.ureticI_MARKA_LOGO || product.URETICI_MARKA_LOGO;
            if (brandLogoPath) {
                brandImg.src = brandLogoPath.startsWith('/') ? brandLogoPath : '/' + brandLogoPath;
                brandImg.alt = product.ureticI_MARKA_ADI || product.URETICI_MARKA_ADI || 'Üretici marka logosu';
                brandDiv.appendChild(brandImg);
            } else {
                brandDiv.style.minHeight = '100px';
            }

            // Fiyat
            const priceDiv = document.createElement('div');
            priceDiv.className = 'product__card--price';
            priceDiv.style.height = '30px';
            priceDiv.style.display = 'flex';
            priceDiv.style.alignItems = 'center';
            priceDiv.style.justifyContent = 'center';
            priceDiv.style.marginTop = 'auto';
            const priceSpan = document.createElement('span');
            priceSpan.className = 'current__price';
            const fiyat = product.satiS_FIYAT || product.SATIS_FIYAT || 0;
            const formattedPrice = formatTurkishLira(fiyat);
            priceSpan.textContent = formattedPrice;
            priceDiv.appendChild(priceSpan);

            // Footer - Sepete Ekle butonu
            const footerDiv = document.createElement('div');
            footerDiv.className = 'product__card--footer';
            footerDiv.style.marginTop = '8px';
            const addToCartBtn = document.createElement('a');
            addToCartBtn.className = 'product__card--btn primary__btn';
            addToCartBtn.href = '';
            addToCartBtn.onclick = function (e) {
                e.preventDefault();
                if (typeof CartManager !== 'undefined') {
                    CartManager.addToCart(productId, 1);
                }
            };

            // SVG icon
            const svgIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svgIcon.setAttribute('width', '14');
            svgIcon.setAttribute('height', '11');
            svgIcon.setAttribute('viewBox', '0 0 14 11');
            svgIcon.setAttribute('fill', 'none');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M13.2371 4H11.5261L8.5027 0.460938C8.29176 0.226562 7.9402 0.203125 7.70582 0.390625C7.47145 0.601562 7.44801 0.953125 7.63551 1.1875L10.0496 4H3.46364L5.8777 1.1875C6.0652 0.953125 6.04176 0.601562 5.80739 0.390625C5.57301 0.203125 5.22145 0.226562 5.01051 0.460938L1.98707 4H0.299574C0.135511 4 0.0183239 4.14062 0.0183239 4.28125V4.84375C0.0183239 5.00781 0.135511 5.125 0.299574 5.125H0.721449L1.3777 9.78906C1.44801 10.3516 1.91676 10.75 2.47926 10.75H11.0339C11.5964 10.75 12.0652 10.3516 12.1355 9.78906L12.7918 5.125H13.2371C13.3777 5.125 13.5183 5.00781 13.5183 4.84375V4.28125C13.5183 4.14062 13.3777 4 13.2371 4ZM11.0339 9.625H2.47926L1.86989 5.125H11.6433L11.0339 9.625ZM7.33082 6.4375C7.33082 6.13281 7.07301 5.875 6.76832 5.875C6.4402 5.875 6.20582 6.13281 6.20582 6.4375V8.3125C6.20582 8.64062 6.4402 8.875 6.76832 8.875C7.07301 8.875 7.33082 8.64062 7.33082 8.3125V6.4375ZM9.95582 6.4375C9.95582 6.13281 9.69801 5.875 9.39332 5.875C9.0652 5.875 8.83082 6.13281 8.83082 6.4375V8.3125C8.83082 8.64062 9.0652 8.875 9.39332 8.875C9.69801 8.875 9.95582 8.64062 9.95582 8.3125V6.4375ZM4.70582 6.4375C4.70582 6.13281 4.44801 5.875 4.14332 5.875C3.8152 5.875 3.58082 6.13281 3.58082 6.4375V8.3125C3.58082 8.64062 3.8152 8.875 4.14332 8.875C4.44801 8.875 4.70582 8.64062 4.70582 8.3125V6.4375Z');
            path.setAttribute('fill', 'currentColor');
            svgIcon.appendChild(path);

            addToCartBtn.appendChild(svgIcon);
            const btnText = document.createTextNode(' Sepete Ekle');
            addToCartBtn.appendChild(btnText);
            footerDiv.appendChild(addToCartBtn);

            // Content'e tüm elementleri ekle
            contentDiv.appendChild(titleH3);
            contentDiv.appendChild(oemH5);
            contentDiv.appendChild(brandDiv);
            contentDiv.appendChild(priceDiv);
            contentDiv.appendChild(footerDiv);

            // Article'a thumbnail ve content ekle
            article.appendChild(thumbnailDiv);
            article.appendChild(contentDiv);

            // Col'a article ekle
            colDiv.appendChild(article);

            return colDiv;
        }

    </script>
}