@{
    ViewData["Title"] = "Ödeme";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Start breadcrumb section -->
<section class="breadcrumb__section breadcrumb__bg">
    <div class="container">
        <div class="row row-cols-1">
            <div class="col">
                <div class="breadcrumb__content text-center">
                    <h1 class="breadcrumb__content--title mb-15">Ödeme</h1>
                    <ul class="breadcrumb__content--menu d-flex justify-content-center">
                        <li class="breadcrumb__content--menu__items"><a href="/">Ana Sayfa</a></li>
                        <li class="breadcrumb__content--menu__items"><span>Ödeme</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- End breadcrumb section -->
<!-- Start checkout section -->
<section class="checkout__section section--padding">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="checkout__form--inner">
                    <form id="paymentForm" class="checkout__form">
                        @Html.AntiForgeryToken()
                        <div class="row justify-content-center">
                            <div class="col-lg-6 col-md-8">
                                <div class="checkout__summary">
                                    <div class="checkout__summary--inner">
                                        <h2 class="checkout__summary--title mb-20 text-center">Test Ödeme</h2>
                                        <div class="checkout__summary--total">
                                            <table class="checkout__summary--total__table">
                                                <tbody>
                                                    <tr class="checkout__summary--total__list">
                                                        <td class="checkout__summary--total__title text-left">
                                                            Toplam
                                                            Tutar
                                                        </td>
                                                        <td class="checkout__summary--amount text-right">
                                                            <span id="totalAmountDisplay">
                                                                @((ViewBag.TotalAmount ??
                                                                                                                                0).ToString("N2")) ₺</ span >
                                                        </td>
                                                    </tr>
                                                </tbody>
                                                <tfoot class="checkout__summary--footer">
                                                    <tr class="checkout__summary--footer__items">
                                                        <td class="checkout__summary--footer__title text-left">
                                                            Genel
                                                            Toplam
                                                        </td>
                                                        <td class="checkout__summary--footer__amount text-right">
                                                            <span id="finalTotalAmountDisplay">
                                                                @((ViewBag.TotalAmount ??
                                                                                                                                0).ToString("N2")) ₺</ span >
                                                        </td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                        <div class="checkout__summary--footer__btn text-center">
                                            <button type="submit"
                                                    class="checkout__summary--footer__btn--link primary__btn"
                                                    id="submitPaymentBtn">
                                                Ödemeyi Başlat
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- End checkout section -->
@section Styles {
    <style>
        .checkout__form--input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e5e5e5;
            border-radius: 5px;
            font-size: 14px;
        }

            .checkout__form--input:focus {
                outline: none;
                border-color: #007bff;
            }

        .checkout__summary {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 5px;
        }

        #submitPaymentBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
}

@section Scripts {
    <script>
     

        // Rastgele test verileri oluştur
        function generateRandomTestData() {
            const cities = ['Istanbul', 'Ankara', 'Izmir', 'Bursa', 'Antalya', 'Adana'];
            const districts = ['Kadıköy', 'Şişli', 'Beşiktaş', 'Üsküdar', 'Beyoğlu', 'Bakırköy'];
            const streets = ['Test Caddesi', 'Örnek Sokak', 'Demo Yolu', 'Sample Street'];
            
            const randomCity = cities[Math.floor(Math.random() * cities.length)];
            const randomDistrict = districts[Math.floor(Math.random() * districts.length)];
            const randomStreet = streets[Math.floor(Math.random() * streets.length)];
            const randomNumber = Math.floor(Math.random() * 100) + 1;
            
            // Rastgele TC Kimlik No (11 haneli)
            const randomTc = Math.floor(10000000000 + Math.random() * 90000000000).toString();
            
            // Rastgele telefon
            const randomPhone = '+90555' + Math.floor(1000000 + Math.random() * 9000000).toString();
            
            // Rastgele email
            const randomEmail = 'test' + Math.floor(Math.random() * 10000) + '@@otomar.com';
            
            return {
                creditCardNumber: '5218487962459752',
                creditCardExpDateMonth: '12',
                creditCardExpDateYear: '28',
                creditCardCvv: '000',
                order: {
                    email: randomEmail,
                    identityNumber: randomTc,
                    billingAddress: {
                        name: 'Test Kullanıcı',
                        phone: randomPhone,
                        city: randomCity,
                        district: randomDistrict,
                        street: `${randomStreet} No:${randomNumber}`
                    },
                    shippingAddress: {
                        name: 'Test Kullanıcı',
                        phone: randomPhone,
                        city: randomCity,
                        district: randomDistrict,
                        street: `${randomStreet} No:${randomNumber}`
                    },
                    corporate: null // Bireysel sipariş için null
                }
            };
        }

        // Form submit
        document.getElementById('paymentForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitPaymentBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'İşleniyor...';

            // Rastgele test verileri oluştur
            const paymentData = generateRandomTestData();

            console.log('Gönderilen test verileri:', paymentData);

            try {
                const response = await makeRequest('/odeme/satin-alim-baslat', 'POST', paymentData);

                if (response && response.redirectUrl) {
                    window.location.href = response.redirectUrl;
                } else {
                    if (typeof showToast !== 'undefined') {
                        showToast('Ödeme başlatılamadı. Lütfen tekrar deneyiniz.', 'error', 'Hata');
                    } else if (typeof toastr !== 'undefined') {
                        toastr.error('Ödeme başlatılamadı. Lütfen tekrar deneyiniz.', 'Hata');
                    } else {
                        alert('Ödeme başlatılamadı. Lütfen tekrar deneyiniz.');
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Ödemeyi Başlat';
                }
            } catch (error) {
                console.error('Error:', error);
                const errorMessage = error.detail || error.message || 'Bir hata oluştu. Lütfen tekrar deneyiniz.';
                const errorTitle = error.title || 'Hata';

                if (typeof handleError !== 'undefined') {
                    handleError(error);
                } else if (typeof showToast !== 'undefined') {
                    showToast(errorMessage, 'error', errorTitle);
                } else if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage, errorTitle);
                } else {
                    alert(errorMessage);
                }

                submitBtn.disabled = false;
                submitBtn.textContent = 'Ödemeyi Başlat';
            }
        });
    </script>
}